<%@ Master Language="C#" Inherits="System.Web.Mvc.ViewMasterPage" %>

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head id="Head1" runat="server">
     <title><asp:ContentPlaceHolder ID="TitleContent" runat="server" /></title>
     <meta name="viewport" content="width=device-width, initial-scale=1" />
     <link rel="shortcut icon" href="../../Content/images/logo2.ico"/>
     <link rel="stylesheet" href="../../Content/jquery.mobile-1.4.0a.css" />
     <link rel="stylesheet" href="../../Content/jquery.mobile.structure-1.4.0.css" />
  <script type="text/javascript" src="../../Scripts/markerclusterer.js"></script>
  <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?v=3"></script>
  <script src="http://code.jquery.com/jquery-1.11.1.min.js"></script>
<script src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
<script type="text/javascript" src="../../Scripts/lawnchair.js"></script>
<script type="text/javascript" src="../../Scripts/jquery.qrcode-0.12.0.min.js"></script>
   


<script type="text/javascript">

   

   // $(document).on("mobileinit", function () {
     //   $.mobile.ajaxEnabled = false;
     //   $.mobile.loadingMessage = false;
//    });


    $(document).bind("pageinit", function () {

        $(function () {

            $(window).bind('resize', function (event) {
                var content_height = $.mobile.activePage.children('[data-role="content"]').height(),
            header_height = $.mobile.activePage.children('[data-role="header"]').height(),
            footer_height = $.mobile.activePage.children('[data-role="footer"]').height(),
            window_height = $(this).height();

                if (content_height < (window_height - header_height - footer_height)) {
                    $.mobile.activePage.css('min-height', (content_height + header_height + footer_height));
                    setTimeout(function () {
                        $.mobile.activePage.children('[data-role="footer"]').css('top', 0);
                    }, 500);
                }
                event.stopImmediatePropagation();
            }).trigger('resize');

            $(window).scroll(function () {
                var toppix = $(window).scrollTop();
                if (parseInt(toppix) > 0) {
                    //
                    timerS = setTimeout(fireMenu, 1000);
                }

            });



            var fireMenu = function () {
                clearTimeout(timerS);
                var toppix = $(window).scrollTop();
                var kindle_sc = checkKindle_sc();

                if (parseInt(toppix) == 0 && kindle_sc == "on") {
                    $("#lnkDialog").click();
                    $('#refreshMsg').html("Refreshing all in 10 seconds");
                    timerR = setTimeout(fireRefresh, 10000);

                }

            };

            var fireRefresh = function () {
                clearTimeout(timerR);
                //alert("refresh");
                location.reload();
            };


            var RefreshPage = function () {
                clearTimeout(timerRefAll);
                //alert("refresh");
                location.reload();
            };

            function cancelRefresh() {
                // alert("moved");
                clearTimeout(timerR);
                $('#refreshMsg').html("");
            }

            var header = document.getElementById('headtext');
            //alert(header.innerHTML);
            //document.getElementById('headtext')

            var timerB;
            if (isKindle() == true) {
                //$("#covertop").show();
                $('#flip-k').val('yes').slider('refresh');
                $('#kindletricks').show();
            } else {

            }

            //start refresh timer
            // getTweets(5);
  //          viewDevices();
            getZeroURL();
            checkWidth();
            clearTimeout(timerB);
            var cookies = listCookies();
            $("#cookies").html(cookies);
            //timerB = setTimeout(loadBlack, 1000);
            //saveLogin();
            //ListArticles();
            //users_check();

        });

        loadBlack();

    });

       $(document).ready(function () {

           // if ($('#add_site').hasClass('ui-collapsible-collapsed')
   
       });




       function loadBlack() {
           $("#covertop").hide();
       }


      

       function Auth(val, type) {
           if (val == "1") {
                document.location.href = '/Mobile/Auth' + type;
           } else {
               //delete cookies
               document.location.href = '/Mobile/DeleteCookies?type=' + type;
           }

       }

       function isKindle() {
           var agent = navigator.userAgent;
           if (agent.indexOf("Kindle") > 0) {
               return true
           } else {
               return false
           }
       }

       function checkWidth() {
           var browser_w = parseInt($(document).width())
           if (parseInt(browser_w) < 560) {

               $("#divider1").show();
               $("#divider2").show();
           } else {
               $("#divider1").hide();
               $("#divider2").hide();
           }


       }

       function editD2g() {
           $("#DatesList").html("Dates here");
       }

       function getZeroURL() {
           var guid = get_cookie("GUID");
           var cookies = listCookies();
           if (guid != undefined) {
           $("#zeroURL").html("http://fridgedoor.apphb.com/Mobile/Index?zcguid=" + guid);
          } else {
          $("#zeroURL").html("Google or Twitter not yet authenticated");
           }
           $("#allcookies").html(cookies);
       }

       function ChangeLoc() {
           document.location.href = '/Mobile/DeleteCookies?type=weather';
       }

       function addDevice() {

           var html_ad = "<ul data-role=\"listview\" data-inset=\"true\"><li class=\"ui-field-contain\"><input type=\"text\" name=\"text-basic\" id=\"device-name\" value=\"Device name here, i.e. Kitchen or Bob\" />" +
"</li><li class=\"ui-field-contain\"><fieldset data-role=\"controlgroup\" data-mini=\"true\"><input type=\"radio\" name=\"radio-choice-m\" id=\"radio-choice-c\" value=\"0\">" +
"<label for=\"radio-choice-c\">No Messaging</label><input type=\"radio\" name=\"radio-choice-m\" id=\"radio-choice-d\" value=\"1\" checked=\"checked\">" +
"<label for=\"radio-choice-d\">View Messages</label><input type=\"radio\" name=\"radio-choice-m\" id=\"radio-choice-e\" value=\"2\">" +
"<label for=\"radio-choice-e\">View and Send</label><input type=\"radio\" name=\"radio-choice-m\" id=\"radio-choice-f\" value=\"3\">" +
"<label for=\"radio-choice-f\">Advanced Messaging (All Twitter message types)</label></fieldset></li>" +
"<li class=\"ui-field-contain\"><fieldset data-role=\"controlgroup\" data-mini=\"true\"><input type=\"radio\" name=\"radio-choice-e\" id=\"radio1\" value=\"0\">" +
"<label for=\"radio1\">No Events</label><input type=\"radio\" name=\"radio-choice-e\" id=\"radio2\" value=\"1\" checked=\"checked\">" +
"<label for=\"radio2\">View Events</label></fieldset></li>" +
"<li class=\"ui-field-contain\"><fieldset data-role=\"controlgroup\" data-mini=\"true\"><input type=\"radio\" name=\"radio-choice-w\" id=\"radio3\" value=\"0\">" +
"<label for=\"radio3\">No Weather</label><input type=\"radio\" name=\"radio-choice-w\" id=\"radio4\" value=\"1\" checked=\"checked\">" +
"<label for=\"radio4\">View Weather</label></fieldset></li>" +
"<li class=\"ui-field-contain\"><a href=\"#\" class=\"ui-btn ui-btn-c\" onclick=\"addNewuser()\">Submit</a></li></ul></form></div>";

           $("#deviceAdd").html(html_ad).trigger('create');
       }

       function loadSpinner() {
           $body = $("body");
           $body.addClass("loading");
       }

       function ListDevices() {

           //list devices
           var listhtml = "";
           $body = $("body");
           $body.addClass("loading");
           var tophtml = "<ul data-role=\"listview\" data-inset=\"true\">"
           $.ajax({
               type: "GET",
               url: "/Mobile/viewDevices",
               //data: "msg=" + msg + "&wea=" + wea + "&eve=" + eve + "&uname=" + uname,
               dataType: "json", //nothing returned
               success: function (json) {
                   var jsonresp = eval(json);
                   $.each(jsonresp.devices, function (n, item) {

                       listhtml = listhtml + "<li><a href=\"ViewADevice?UserID=" + item.id + "\"><h2>" + item.uname + "</h2><p>Enabled</p>" +
                   "<p class=\"ui-li-aside\">Last seen <strong>" + item.last + "</strong> ago</p></a></li>";
                     //  listhtml = listhtml + "<li><a href=\"ref\">" + item.uname + "</a><span class=\"ui-li-count\">" + item.last + "</span></li>";
                   });
                   $("#deviceList").html(tophtml + listhtml + "</ul>").trigger('create');
                   $body.removeClass("loading");
               },
               error: function (xhr, error) {
                   // console.debug(xhr); console.debug(error);
               },
               complete: function (xhr, status) {

               }
           });


       }

      
       function viewDevices() {

           $body = $("body");
           $body.addClass("loading");
          
           var top_html = "";
           var main_html = "";
           var msg_html = "";
           var events_html = "";
           var radio_html = "";
           var url = "";
           var end_html = "</div>";
           $.ajax({
               type: "GET",
               url: "/Mobile/viewDevices",
               //data: "msg=" + msg + "&wea=" + wea + "&eve=" + eve + "&uname=" + uname,
               dataType: "json", //nothing returned
               success: function (json) {
                   var jsonresp = eval(json);
                   $.each(jsonresp.devices, function (n, item) {
                       if (item.msg == 0) {
                           msg_html = "No messaging";
                       } else if (item.msg == 1) {
                           msg_html = "Messaging: View only";
                       } else if (item.msg == 2) {
                           msg_html = "Messaging: View and Send";
                       } else {
                           msg_html = "Messaging: Advanced";
                       }
                       events_html = "No Events";
                       w_html = "Weather for ...";
                       url = "<a href=\"http://localhost:5010/mobile/indexc?zcguid=" + item.guid + "\">Link</a>";
                       main_html = main_html + "<div class=\"ui-corner-all custom-corners\"><div class=\"ui-bar ui-bar-a\"><h2>" + item.uname + "</h2></div><div class=\"ui-body ui-body-a\">" +
                   "<ul data-role=\"listview\"><li>" + msg_html + "</li><li>" + events_html + "</li><li>" + w_html + "</li><li>Link: " + url + "</li><li><div class=\"ui-grid-a ui-responsive\">" +
                   "<div class=\"ui-block-a\"><fieldset data-role=\"controlgroup\" data-type=\"horizontal\" data-mini=\"true\">" +
                   "<input type=\"radio\" name=\"radio-device-name-" + item.id + "\" id=\"radio-device-id-e" + item.id + "\" value=\"on\" checked=\"checked\">" +
                   "<label for=\"radio-device-id-e" + item.id + "\">Enabled</label>" +
                   "<input type=\"radio\" name=\"radio-device-name-" + item.id + "\" id=\"radio-device-id-d" + item.id + "\" value=\"off\">" +
                   "<label for=\"radio-device-id-d" + item.id + "\">Disabled</label>" +
                   "</fieldset>" +
                   "<div><a href=\"#\" class=\"ui-btn ui-btn-c ui-mini\" onclick=\"deleteUser(" + item.id + ",-1)\">Delete Device</a></div></div>" +
                   "<div class=\"ui-block-b\" style=\"text-align:center\" ><div id=\"chart-div" + item.id + "\"></div></div></div>" +
                    "<br />";
                       //type = refresh
                       //var guid = jsonresp['newguid'];
                       //alert(guid);
                   });
                   //$("#deviceView").html(main_html + end_html).trigger('create');
                   $.each(jsonresp.devices, function (n, item) {
                       //alert("drawQR");
                       $("#chart-div" + item.id).qrcode({
                           "width": 80,
                           "height": 80,
                           "color": "#3a3",
                           "text": "http://fridgedoor.apphb.com/Mobile/Index?zcguid=" + item.guid
                       });
                   });
                   $body.removeClass("loading");
               },
               error: function (xhr, error) {
                   // console.debug(xhr); console.debug(error);
               },
               complete: function (xhr, status) {

               }

           });

       //deviceView
       }

       function addNewuser() {
           $body = $("body");
           $body.addClass("loading");
           var msg = $("input[type='radio'][name='radio-choice-m']:checked").val();
           var eve = $("input[type='radio'][name='radio-choice-e']:checked").val();
           var wea = $("input[type='radio'][name='radio-choice-w']:checked").val();
           var uname = $("input[type='text'][id='device-name']").val();
           //alert(uname);
           // document.getElementByName('radio-choice-b').value;
           //https://chart.googleapis.com/chart?cht=qr&chs=300x300&chl=http://fridgedoor.apphb.com/Mobile/Index?zcguid=d290ca15-cc16-45f9-b86b-3ab4c8e5aa40
           //alert(eve);
           $.ajax({
               type: "GET",
               url: "/Mobile/saveNewuser",
               data: "msg=" + msg + "&wea=" + wea + "&eve=" + eve + "&uname=" + uname,
               dataType: "json", //nothing returned
               success: function (json) {
                   var jsonresp = eval(json);
                   //type = refresh
                   var guid = jsonresp['newguid'];
                   $("#deviceAdd").html("<div class=\"ui-body ui-body-a ui-corner-all\"><div style=\"font-size:20px\">Device " + uname + " saved.</div>").trigger('create');
                   //viewDevices();
                   //redirect to viewdevices with a message
                   document.location.href = '/Mobile/ListDevices?msg=new';
               },
               error: function (xhr, error) {
                   // console.debug(xhr); console.debug(error);
               },
               complete: function (xhr, status) {

               }

           });
       }

       function deleteUser(id,status) {

           $.ajax({
               type: "GET",
               url: "/Mobile/deleteUser",
               data: "id=" + id + "&status=" + status,
               dataType: "json", //nothing returned
               success: function (json) {
                   //var jsonresp = eval(json);
                   //type = refresh
                   //var guid = jsonresp['newguid'];
                   //$("#deviceAdd").html("<div class=\"ui-body ui-body-a ui-corner-all\"><div style=\"font-size:20px\">Device " + uname + " saved.</div>").trigger('create');

                   document.location.href = '/Mobile/ListDevices?msg=del';
               },
               error: function (xhr, error) {
                   // console.debug(xhr); console.debug(error);
               },
               complete: function (xhr, status) {
                   if (status == -1) {
                       document.location.href = '/Mobile/ListDevices?msg=del';
                   } else {
                       document.location.href = '/Mobile/ViewADevice?UserID=' + id;
                   }
               }

           });

       }

       function SetLoc() {
           // $('#locBtn').html("");
           var html = "<div id=\"towns\"><input type=\"text\" id=\"town\" />" +
                "<button onclick=\"setTown()\" class=\"ui-btn ui-btn-b ui-shadow ui-corner-all ui-icon-search\">Search</button></div>";
           //"<div id=\"townmsg\"><div><div id=\"townlist\"><div>";
           $('#setLocation').html(html).trigger('create');
       }

       function SaveLoc(lat, lng, loc) {
           set_cookie("lat", lat, 365);
           set_cookie("long", lng, 365);
           //var loc = "";
           $('#setLocation').html("Saving ...").trigger('create');
           $.ajax({
               type: "GET",
               url: "/Mobile/saveLocation",
               data: "lat=" + lat + "&lng=" + lng + "&loc=" + loc,
               dataType: "text/plain", //nothing returned
               success: function (json) {

               },
               error: function (xhr, error) {
                   // console.debug(xhr); console.debug(error);
               },
               complete: function (xhr, status) {

                   var html = "<a href=\"#\" onclick=\"ChangeLoc()\" class=\"ui-btn ui-btn-b ui-corner-all\">Change</a><div>Location set to: " + loc + " (" + lat + "," + lng + ")</div>";
                   $('#setLocation').html(html).trigger('create');
                   $("#townlist").html("").trigger('create');
                   $("#townmsg").html("").trigger('create');
                   GetWeather(0, 1);
               }

           });
           //alert(lat + "," + lng);
           //GetWeather(0, 1);
           //document.location.href = '/';
       }


       function setTown() {
           var town = document.getElementById('town').value;
           //alert(town);
           var html = "";
           $("#townlist").html("Searching ...").trigger('create');
           $.ajax({
               type: "GET",
               url: "http://api.geonames.org/search?q=" + town + "&maxRows=10&username=fletch1&type=json&orderby=relevance",
               //url: "http://api.geonames.org/findNearbyPlaceNameJSON?lat=" + lat + "&lng=" + lng + "&username=fletch1",
               dataType: "jsonp",
               success: function (json) {
                   var jsonresp = eval(json);
                   $.each(jsonresp.geonames, function (i, geo) {
                       //alert(geo.lat);
                       //var html = "<div onclick=/Home/SaveLatLong?lat=" + geo.lat + "&lng=" + geo.lng + ">" + geo.toponymName + ", " + geo.adminName1 + ", " + geo.countryName + "</div>";
                       // town = geo.toponymName;
                       html = html + "<div style=\"cursor:pointer\" onclick=\"SaveLoc(" + geo.lat + "," + geo.lng + ",'" + geo.toponymName + "')\"><strong>" + geo.toponymName + "</strong>, " + geo.adminName1 + ", " + geo.countryName + "</div>";
                       // adminName1
                       // countryNam  
                   });
                   //alert(html);
                   $("#townmsg").html("<br /><div style=\"font-size:20px\"><strong>Please select a location, or search again.</strong></div>");
                   $("#townlist").html(html).trigger('create');
                   //SaveNewLocation(lat, lng, town);

               },
               error: function (xhr, error) {
                   // console.debug(xhr); console.debug(error);
                   // alert(xhr + "  " + error);
               },
               complete: function (xhr, status) {
                   // console.debug(xhr); console.debug(status);
                   // alert(xhr + " complete" + status);

               }

           });
       }

       function GetWeather_old(lat, lng) {
           $('#flip-w').val('yes').slider('refresh');
           $('#weather').html("");
           //set_cookie("teststore", "val", 1);
           var NewDate = new Date();
           var loc = lat + "," + lng;
           var ck = get_cookie("day0");
           //alert("ck=" + ck);
           if (ck == null) {
               //alert("ck is null");
               //$('#weather').html(loc);
               $.ajax({
                   type: "GET",
                   url: "http://api.wunderground.com/api/bf45926a1b878028/forecast/geolookup/q/" + loc + ".json",
                   dataType: "jsonp",
                   success: function (json) {
                       //var json = eval('(' + jsontxt + ')');
                       //var jsontext = JSON.stringify(json);
                       // $.each(json.Id, function (i, idlist) {
                       //alert(jsontext);
                       //});
                       var i = 0;
                       while (i < 8) {
                           var text = json['forecast']['txt_forecast']['forecastday'][i]['fcttext_metric'];
                           var icon = json['forecast']['txt_forecast']['forecastday'][i]['icon'];
                           if (i > 0 && i < 4) {
                               //  alert(i);
                               var high = "Hi: " + json['forecast']['simpleforecast']['forecastday'][i]['high']['celsius'] + "C";
                               var low = "Lo: " + json['forecast']['simpleforecast']['forecastday'][i]['low']['celsius'] + "C";
                               set_cookie("hi" + i, high, 1);
                               set_cookie("lo" + i, low, 1);
                               //alert(high + " " + low);
                           }
                           set_cookie("day" + i, text, 1);
                           set_cookie("icon" + i, icon, 1);

                           i++;
                       }
                       //var location = json['location']['city'];
                       //alert(location);
                       //document.location.href = '/Mobile/Choose';

                   },
                   error: function (xhr, error) {
                       console.debug(xhr); console.debug(error);
                       //alert(xhr + "  " + error);
                   },
                   complete: function () {

                   }

               });

           } else {


           }

       }

       function testa(max, min) {
           $('#chosenDay').html("<strong>" + formatDateFull(min) + "</strong>");
           var idlistj = get_cookie("IDList");
           //alert("cookie = " + idlistj);
           var browser_w = parseInt($(document).width()) - 60;
           var browser_h = parseInt($(document).height()) - 80;
           $('#iframe1').css('width', browser_w.toString() + 'px');
           $('#iframe1').css('height', browser_h.toString() + 'px');
           $('#eventsDay').html("");
           var jsonc = idlistj;
           var jsone = eval('(' + jsonc + ')');
           var jsone2 = eval('(' + jsonc + ')');
           var count = jsone['Count'];
           //alert(idlist + count);
           var min_bk = parseInt(min) - 1;
           var min_fw = parseInt(min) + 1;
           var max_fw = parseInt(max) + 1;
           var max_bk = parseInt(max) - 1;
           var btn_txt_bk;
           var btn_txt_fw;
           if (parseInt(min) == 0) {
               $('#datebanner').html(formatDate(0));
               btn_txt_bk = "Yesterday";
               btn_txt_fw = "Tomorrow";
           } else {
               $('#datebanner').html(formatDate(min_bk + 1))
               btn_txt_bk = formatDate(min_bk);
               btn_txt_fw = formatDate(max);

           }

           //var bk_btn_html = "<div class=\"term3btn\" style=\"cursor:pointer\" onclick=\"testa(" + max_bk + "," + min_bk + ")\">" + btn_txt_bk + "</div>";
           //var fw_btn_html = "<div class=\"term3btn\" style=\"cursor:pointer\" onclick=\"testa(" + max_fw + "," + min_fw + ")\">" + btn_txt_fw + "</div>";
           // $('#btns').html("<table><tr><td class=\"tdleft\">" + bk_btn_html + "</td><td class=\"tdright\">" + fw_btn_html + "</td><tr><table>");

           $.each(jsone.Id, function (i, idlist) {

               var sumhtml = "<div id=\"sum" + i + "\"></div>";
               $('#eventsDay').append(sumhtml);
               // var summinihtml = "<div id=\"summini" + i + "\"><table><tr><td><div style=\"cursor:pointer\" onclick=\"testa(2,1)\" id=\"day0" + i + "\"></div><div id=\"day_w_0" + i + "\" ></div></td><td><div style=\"cursor:pointer\" onclick=\"testa(3,2)\" id=\"day1" + i + "\"></div><div id=\"day_w_1" + i + "\" ></div></td><td><div style=\"cursor:pointer\" onclick=\"testa(4,3)\" id=\"day2" + i + "\"></div><div id=\"day_w_2" + i + "\" ></div></td><td><div style=\"cursor:pointer\" onclick=\"testa(5,4)\" id=\"day3" + i + "\"></div><div id=\"day_w_3" + i + "\" ></div></td><td><div style=\"cursor:pointer\" onclick=\"testa(6,5)\" id=\"day4" + i + "\"></div><div id=\"day_w_4" + i + "\" ></div></td></tr></table></div>";
               //$('#suminjmini').append(summinihtml);

               var email = getID(i, idlistj);
               var name = getFn(i, idlistj);

               getevents(email, name, i, max, min);
               getfutureevents(email, name, i, max, min);
               // alert(idlist[0]);
           });


           drawDays(min, idlistj);

       }


       function drawDays(min, idlistj) {
       //check for cookie??
           var n = parseInt(min);
           var end = 0;
           var calnext5 = "<div class=\"ui-grid-d\">";
           var weathernext5 = "<div class=\"ui-grid-d\">";
           var aplhastr = "abcde";
           for (var i = 0; i < aplhastr.length; i++) {
               var nextChar = aplhastr.charAt(i);
               //}
               //while (end < 5) {
               end++;
               var n1 = parseInt(n + end);
               //alert(n1 + "..." + end);
               var n2 = parseInt(n1 + 1);
           
               var day = formatDateDay(n1);
               var daynum = formatDate(n1);
               var dispday = formatDateNext(n1);
               dispday = dispday.substring(0, 3) + " " + daynum;
               var dayID = formatDateDayID(n1);
               calnext5 = calnext5 + "<div style=\"cursor:pointer\" class=\"ui-block-" + nextChar + "\"><div style=\"font-size:12px;text-align:left\" onclick=\"testa(" + n2 + "," + n1 + ")\" id=\"" + dayID + "\"><div class=\"term3\">" + dispday + "</div></div></div>";
               var img = get_cookie("icon" + n1);
               var hi = "";
               var lo = "";
               var icon = "";
               if (n1 < 4) {
                   hi = get_cookie("hi" + n1);
                   lo = get_cookie("lo" + n1);
                   icon = "<img src=\"http://icons.wxug.com/i/c/i/" + img + ".gif\">";
               }

               weathernext5 = weathernext5 + "<div class=\"ui-block-" + nextChar + "\"><div>" + icon + "<br />" + hi + "<br />" + lo + "</div></div>";
           }

           $('#calendar_next5').html(calnext5 + "</div>").trigger('create');
           var ckcheck = get_cookie("lat");
           if (ckcheck != null) {
               n = min * 2;
               var n2 = n + 1;
               // var n2 = parseInt(n + 1);
               var forecast2 = get_cookie("day" + n2);
               var forecast = get_cookie("day" + n);
               var img = get_cookie("icon" + n);
               var img2 = get_cookie("icon" + n);
               var icon = "<img src=\"http://icons.wxug.com/i/c/i/" + img + ".gif\">";
               var icon2 = "<img src=\"http://icons.wxug.com/i/c/i/" + img2 + ".gif\">";
               var day = "day.";
               var day2 = "day2.";
               var htmltable = "<table><tr><td>Day <br />" + icon + "</td><td>" + forecast + "</td></tr></table></br>" +
            "<table><tr><td>Night <br />" + icon2 + "</td><td>" + forecast2 + "</td></tr></table>";
               //$('#weather').append(day + "</br>" + forecast + "</br>" + day2 + "</br>" + forecast2 + "<img src=\"http://icons.wxug.com/i/c/i/" + icon2 + ".gif\" />");

               $('#weather').html(htmltable).trigger('create');
               $('#weather_next5').html(weathernext5 + "</div>").trigger('create');
           }
       }


       function drawDaysnoCal(n) {
           //var n = parseInt(1);
           $('#weatherday').html("<strong>" + formatDateFull(n) + "</strong>").trigger('create');
           var end = 0;
           var calnext5 = "<div class=\"ui-grid-d\">";
           var weathernext5 = "<div class=\"ui-grid-d\">";
           var aplhastr = "abc";
           for (var i = 0; i < aplhastr.length; i++) {
               var nextChar = aplhastr.charAt(i);
               //}
               //while (end < 5) {
               end++;
               var n1 = parseInt(n + end);
               //alert(n1 + "..." + end);
               var n2 = parseInt(n1 + 1);
               var day = formatDateDay(n1);
               var daynum = formatDate(n1);
               var dispday = formatDateNext(n1);
               dispday = dispday.substring(0, 3) + " " + daynum;
               var dayID = formatDateDayID(n1);          
               calnext5 = calnext5 + "<div style=\"cursor:pointer\" class=\"ui-block-" + nextChar + "\"><div style=\"font-size:12px;text-align:left\" onclick=\"drawDaysnoCal(" + n1 + ")\" id=\"" + dayID + "\"><div class=\"term3\">" + dispday + "</div></div></div>";
               var img = get_cookie("icon" + parseInt(n1 * 2)); //fix cal weather
               var hi = "";
               var lo = "";
               var icon = "";
               if (n1 < 4) {
                   hi = get_cookie("hi" + n1);
                   lo = get_cookie("lo" + n1);
                   icon = "<img src=\"http://icons.wxug.com/i/c/i/" + img + ".gif\">";
               }

               weathernext5 = weathernext5 + "<div class=\"ui-block-" + nextChar + "\"><div>" + icon + "<br />" + hi + "<br />" + lo + "</div></div>";
           }
           n = n * 2;
           var n2 = n + 1;

           var forecast2 = get_cookie("day" + n2);
           var forecast = get_cookie("day" + n);
           var img2 = get_cookie("icon" + n);
           var icon = "<img src=\"http://icons.wxug.com/i/c/i/" + img + ".gif\">";
           var icon2 = "<img src=\"http://icons.wxug.com/i/c/i/" + img2 + ".gif\">";
           var htmltable = "<table><tr><td>Day <br />" + icon + "</td><td>" + forecast + "</td></tr></table></br>" +
            "<table><tr><td>Night <br />" + icon2 + "</td><td>" + forecast2 + "</td></tr></table>";
           //$('#weather').append(day + "</br>" + forecast + "</br>" + day2 + "</br>" + forecast2 + "<img src=\"http://icons.wxug.com/i/c/i/" + icon2 + ".gif\" />");
           //$('#weather').append(htmltable);
           $('#weatherblocdata').html(htmltable);

           $('#calendarbloc_next5').html(calnext5 + "</div>").trigger('create');
           $('#weatherbloc_next5').html(weathernext5 + "</div>").trigger('create');

       }


       var timer1;

       var timer2;

       function timerStart1(ID) {
           //clearTimeout(timer1);
           //timer1 = setTimeout(closeBanner1, ti);
           //alert("banner for " + ID);
           closeBanner();
       }

       var timerA;



       function closeBanner() {
           $("#banner_area").html("");
           $("#banner_header").html("")
           $("#banner_header").hide();
           $("#banner_area").hide();
       }

       function goSetup() {
           window.location.href = '/Home/Choose';
       }

       function GetWeather(min, max) {
           var lat = get_cookie("lat");
           var lng = get_cookie("long");
           if (lat == null) {
               $('#weather').hide();
               $('#weather_next5').hide();

               $('#sidemsg-w').html("Set location");
               $('#greeting').hide;
               $('#flip-w').val('no').slider('refresh');
               $('#flip-g').val('yes').slider('refresh');
               $('#greeting').hide();
               $('#welcome').show();
           } else {
               $('#weather').show();
               $('#weather_next5').show();
               $('#weather').html("");
               $('#weatherblocdata').html("");
               //set_cookie("teststore", "val", 1);
               var NewDate = new Date();
               var loc = lat + "," + lng;
               min = min * 2;
               max = min + 1;
               var ck = get_cookie("day0");
               //get weather cookie creation time
               var w_data = get_cookie("w_data");
               var epoch = Math.round(new Date().getTime() / 1000)
               var diff = parseInt(3000);
               if (w_data != null) {
                   diff = parseInt(parseInt(epoch) - parseInt(w_data));
               }
               if (ck == null && diff > 2000) {
                   //alert("diff:" + diff + " new data");
                   //$('#weather').html(loc);
                   $.ajax({
                       type: "GET",
                       url: "http://api.wunderground.com/api/bf45926a1b878028/forecast/geolookup/q/" + loc + ".json",
                       dataType: "jsonp",
                       success: function (json) {
                           var i = 0;
                           while (i < 8) {
                               var text = json['forecast']['txt_forecast']['forecastday'][i]['fcttext_metric'];
                               var icon = json['forecast']['txt_forecast']['forecastday'][i]['icon'];
                               if (i > 0 && i < 4) {
                                   //  alert(i);
                                   var high = "Hi: " + json['forecast']['simpleforecast']['forecastday'][i]['high']['celsius'] + "C";
                                   var low = "Lo: " + json['forecast']['simpleforecast']['forecastday'][i]['low']['celsius'] + "C";
                                   set_cookie("hi" + i, high, 1);
                                   set_cookie("lo" + i, low, 1);
                                   //alert(high + " " + low);
                               }
                               set_cookie("day" + i, text, 1);
                               set_cookie("icon" + i, icon, 1);

                               i++;
                           }
                           var location = json['location']['city'];

                           //   $('#footer').html("Location: " + location + "(" + lat + ", " + lng + ")</br>" + "Updated: " + NewDate);
                           //$('#weather').append("Weather for " + location);
                           var day = json['forecast']['txt_forecast']['forecastday'][min]['title'];
                           //alert("day=" + day);
                           var day2 = json['forecast']['txt_forecast']['forecastday'][max]['title'];
                           var forecast = json['forecast']['txt_forecast']['forecastday'][min]['fcttext_metric'];
                           var forecast2 = json['forecast']['txt_forecast']['forecastday'][max]['fcttext_metric'];
                           var icon = json['forecast']['txt_forecast']['forecastday'][min]['icon'];
                           var icon2 = json['forecast']['txt_forecast']['forecastday'][max]['icon'];
                           var img1 = "<img src=\"http://icons.wxug.com/i/c/i/" + icon + ".gif\">";
                           var img2 = "<img src=\"http://icons.wxug.com/i/c/i/" + icon2 + ".gif\">";
                           //set_cookie("0text", forecast, 1);
                           //set_cookie("0icon", forecast, 1);
                           //var htmltable = "<table><tr><td>" + day + ":  </td><td>" + forecast + "</td></tr><tr><td>" + day2 + ":  </td><td>" + forecast2 + "</td></tr></table>";
                           //$('#weather').append(day + "</br>" + forecast + "</br>" + day2 + "</br>" + forecast2 + "<img src=\"http://icons.wxug.com/i/c/i/" + icon2 + ".gif\" />");
                           var htmltable = "<table><tr><td>Day <br />" + img1 + "</td><td>" + min + " " + forecast + "</td></tr></table></br>" +
            "<table><tr><td>Night <br />" + img2 + "</td><td>" + max + " " + forecast2 + "</td></tr></table>";
                           //alert(htmltable); min was here
                           $('#weather').html(htmltable).trigger('create');
                           $('#weatherblocdata').append(htmltable).trigger('create');
                           //next 5 ???
                           var epoch = Math.round(new Date().getTime() / 1000);
                           set_cookie("w_data", epoch, 2);
                       },
                       error: function (xhr, error) {
                           console.debug(xhr); console.debug(error);
                           $('#footer').appnd(xhr + "  " + error);
                       },
                       complete: function () {

                       }

                   });

               } else {
                   var forecast = get_cookie("day" + min);
                   var forecast2 = get_cookie("day" + max);
                   var img = get_cookie("icon" + min);
                   var img2 = get_cookie("icon" + max);
                   var icon = "<img src=\"http://icons.wxug.com/i/c/i/" + img + ".gif\">";
                   var icon2 = "<img src=\"http://icons.wxug.com/i/c/i/" + img2 + ".gif\">";
                   var htmltable = "<table><tr><td>Day <br />" + icon + "</td><td>" + forecast + "</td></tr></table></br>" +
            "<table><tr><td>Night <br />" + icon2 + "</td><td>" + forecast2 + "</td></tr></table>";
                   //$('#weather').append(day + "</br>" + forecast + "</br>" + day2 + "</br>" + forecast2 + "<img src=\"http://icons.wxug.com/i/c/i/" + icon2 + ".gif\" />");
                   $('#weather').html(htmltable).trigger('create');
                   $('#weatherblocdata').append(htmltable).trigger('create');

               }
           }

       }

       function getevents(email, name, i, max, min) {
           $.ajax({
               type: "POST",
               url: "/Mobile/DoneTest",
               data: "email=" + email + "&max=" + max + "&min=" + min,
               dataType: "json",
               success: function (json) {
                   var jsonresp = eval(json);
                   //type = refresh
                   var typej = jsonresp['type'];
                   if (typej == "refresh") {
                       //alert("refreshing");
                       //window.location.href = '/Mobile/GoogleRefresh';
                       $.ajax({
                           type: "GET",
                           url: "/Mobile/GoogleRefresh",

                           dataType: "json",
                           success: function () {
                               getevents(email, name, i, max, min)
                           },
                           error: function () { getevents(email, name, i, max, min); }
                       });
                   } else {
                       var summary = jsonresp['summary'];

                       // alert("not refreshing");
                       var item_ct = 0;
                       for (_obj in jsonresp.items) item_ct++;
                       //alert(item_ct);
                       if (item_ct != 0) {
                           var datestr = formatDate(min);
                           //$('#sum' + i).append("<br /><div class=\"term1\">" + name + "</div>");
                           $.each(jsonresp.items, function (n, item) {
                               if (item.status != "cancelled") {
                                   var datetest = item.start.dateTime;
                                   var datetest2 = item.start.date;
                                   var start_dt = new Date(item.start.dateTime);
                                   var end_dt = new Date(item.end.dateTime);
                                   var start_d = new Date(item.start.date);
                                   var end_d = new Date(item.end.date);
                                   var stf = parseISO8601Date(item.start.dateTime);
                                   var endf = parseISO8601Date(item.end.dateTime);
                                   //var dts = formatDT(itemstart,"start",itemend);
                                   var dte = "";
                                   if (start_dt != "Invalid Date") {
                                       // dte = start_dt.toString('H:mm tt') + " - " + end_dt;
                                   } else {
                                       // dte = "All day";
                                   }
                                   //formatDT(itemstart, itemend, min); write this back in
                                   var location = "";
                                   if (item.location != undefined) {
                                       location = ", " + item.location;
                                   }
                                   $('#sum' + i).append("<div class=\"term3\">" + stf + " - " + endf + "</div>    <div class=\"term1evt\">" + item.summary + location + "</div>").trigger('create');
                               }

                           });
                       } else {
                           //     $('#sum' + i).append("<br /><div class=\"term1\">No events for " + name + "</div>");
                       }
                   }
               },
               error: function (xhr, error) {
                   // console.debug(xhr); console.debug(error);

               },
               complete: function (xhr, status) {
               }

           });
       }

       function getfutureevents(email, name, i, max, min) {
           //inject html
           max = max + 5;
           min = max - 5;
           $.ajax({
               type: "POST",
               url: "/Mobile/DoneTest",
               data: "email=" + email + "&max=" + max + "&min=" + min,
               dataType: "json",
               success: function (json) {
                   var jsonresp = eval(json);
                   //type = refresh
                   var typej = jsonresp['type'];
                   if (typej == "refresh") {
                       //alert("refreshing");
                       //window.location.href = '/Mobile/GoogleRefresh';
                       $.ajax({
                           type: "GET",
                           url: "/Mobile/GoogleRefresh",

                           dataType: "json",
                           success: function () {
                               getfutureevents(email, name, i, 1, 0);
                           },
                           error: function () { getfutureevents(email, name, i, 1, 0); }
                       });
                   } else {
                       var summary = jsonresp['summary'];

                       // alert(jsonresp.items.count());
                       var item_ct = 0;
                       for (_obj in jsonresp.items) item_ct++;
                       //alert(item_ct);
                       if (item_ct != 0) {
                           var datestr = formatDate(min);
                           var day = "";
                           var oldday = "new";
                           var head = "";
                           var dayct = parseInt(0);
                           $.each(jsonresp.items, function (n, item) {
                               if (item.status != "cancelled") {
                                   var datetest = item.start.dateTime;
                                   var datetest2 = item.start.date;
                                   var start_dt = new Date(item.start.dateTime);
                                   var end_dt = new Date(item.end.dateTime);
                                   var start_d = new Date(item.start.date);
                                   var end_d = new Date(item.end.date);
                                   var stf = parseISO8601Date(item.start.dateTime);
                                   var endf = parseISO8601Date(item.end.dateTime);
                                   //alert(item.summary + " " + endf);
                                   if (endf == "All day") {
                                       stf = endf;
                                       var daytest = parseISO8601_short(item.start.date); //formats date from yyyy-mm-dd
                                       //alert("daytest=" + daytest);
                                       var res = daytest.toString().split(" ");
                                       // alert(res);
                                       var fullday = getProperDay(res[0]);
                                       var justdate = res[2];
                                   } else {
                                       var daytest = parseISO8601DateFull(item.start.dateTime);
                                       //alert("daytimetest=" + daytest);
                                       var res = daytest.toString().split(" ");
                                       // alert(res);
                                       var fullday = getProperDay(res[0]);
                                       var justdate = res[2];
                                   }
                                   //$('#debug').append(fullday);

                                   day = fullday + justdate; //needs a day of week number
                                   //alert(day);
                                   $('#' + day).append("<div class=\"term4\">" + stf + "</div><div class=\"term1evt\">" + item.summary + "</div>");

                               }


                           });


                       } else {

                       }
                   }
               },
               error: function (xhr, error) {
                   // console.debug(xhr); console.debug(error);
               },
               complete: function (xhr, status) {
               }

           });
       }



       function getID(num, idlist) {
           var jsone = eval('(' + idlist + ')');
           return jsone.Id[num];
       }

       function getFn(num, idlist) {
           var jsone = eval('(' + idlist + ')');
           return jsone.Fullname[num];
       }


       function ggl_check(type) {
           $.ajax({
               type: "GET",
               url: "/Mobile/checkGglIDlist",
               //data: "latestID=" + latestID,
               dataType: "json",
               success: function (json) {
                   var jsonresp = eval(json);
                   //alert("ggl check=" + jsonresp.IDlist);
                   idlist = jsonresp.IDlist;
                   if (idlist == "No IDList") {
                       if (type == "cal") {
                           $('#sidemsg-c').html("Authenticate");
                           $('#flip-c').val('no').slider('refresh');
                           $('#flip-g').val('yes').slider('refresh');
                       } else {
                           $('#flip-d').val('no').slider('refresh');
                           $('#sidemsg-d1').show();
                           $('#sidemsg-d1').html("Authenticate");
                       }

                       $('#greeting').hide();
                       $('#welcome').show();
                   } else {
                       if (type == "cal") {
                           drawCal();
                           drawNext5(0);
                           $('#calblock').show();
                           testa(1, 0);
                       } else {
                           $('#days2go').show()
                           getDays2Go("normal");
                           $('#sidemsg-d').show();
                       }
                   }
               },
               error: function (xhr, error) {
                   // console.debug(xhr); console.debug(error);
               },
               complete: function (xhr, status) {
                   // return idlist;
               }

           });
       }

       function users_check() {
           var k_html = "";
           var ch_html = "";
           var html_top = "<div class=\"ui-body ui-body-a ui-corner-all\">";
           $.ajax({
               type: "GET",
               url: "/Mobile/getAgents",
               //data: "latestID=" + latestID,
               dataType: "json",
               success: function (json) {
                   var jsonresp = eval(json);
                   var total_html = "<div style=\"font-size:20px\">OK Fridge Community</div><br /><div style=\"font-size:18px\">" + jsonresp.total + " live Devices</div>";
                   var grid_html = "<div class=\"ui-grid-c\">" +
                                   "<div class=\"ui-block-a\"><p style=\"font-size:16px;text-align: center\">Kindle</p><p style=\"text-align: center\">" + jsonresp.kindles + "</p></div>" +
                                    "<div class=\"ui-block-b\"><p style=\"font-size:16px;text-align: center\">iOS</p><p style=\"text-align: center\">" + jsonresp.iOS + "</p></div>" +
                                    "<div class=\"ui-block-c\"><p style=\"font-size:16px;text-align: center\">Android</p><p style=\"text-align: center\">" + jsonresp.android + "</p></div>" +
                                    "<div class=\"ui-block-d\"><p style=\"font-size:16px;text-align: center\">Windows</p><p style=\"text-align: center\">" + jsonresp.windows + "</p></div>" +                                
                                    "</div>";
                   var grid2_html = "<div class=\"ui-grid-b\">" +
                                    "<div class=\"ui-block-a\"><div style=\"font-size:30px\"><img id=\"logoIMG\" style=\"vertical-align: text-top\" src=\"../../Content/images/Twitter_small.png\"/><div style=\"display:inline;color:#5EA9DD;padding-top:10px\">" + jsonresp.twtr_usrs + "</div></div></div>" +
                                    "<div class=\"ui-block-b\"><div style=\"font-size:30px\"><img id=\"logoIMG\" style=\"vertical-align: text-top\" src=\"../../Content/images/calendar-64.png\"/><div style=\"display:inline;color:#5EA9DD\">" + jsonresp.ggl_usrs + "</div></div></div>" +
                                    "<div class=\"ui-block-c\"><div style=\"font-size:30px\"><img id=\"logoIMG\" style=\"vertical-align: text-top\" src=\"../../Content/images/maps_small.png\"/><div style=\"display:inline;color:#5EA9DD\">" +
                                    "<a href=\"#\" class=\"ui-btn ui-btn-inline ui-btn-icon-right ui-icon-location\" onClick=\"displayMap(); return false;\">" + jsonresp.locations + "</a></div></div></div>";
                   //+ maps small icon and move locations

                   $('#stats').html(html_top + total_html + grid_html + html_top + grid2_html).trigger('create');

               },
               error: function (xhr, error) {
                   // console.debug(xhr); console.debug(error);
               },
               complete: function (xhr, status) {
                   // return idlist;
               }

           });
       }

      

       function saveLogin() {
           $.ajax({
               type: "GET",
               url: "/Mobile/saveLogin",
               dataType: "json",
               success: function (json) {

               },
               error: function (xhr, error) {
                   // console.debug(xhr); console.debug(error);
               },
               complete: function (xhr, status) {
                   // return idlist;
               }

           });
       }



       function twt_check() {
           $.ajax({
               type: "GET",
               url: "/Mobile/checkTwtID",
               //data: "latestID=" + latestID,
               dataType: "json",
               success: function (json) {
                   var jsonresp = eval(json);
                   //alert(jsonresp.IDlist);
                   idlist = jsonresp.ID;
                   //alert(idlist);
                   if (idlist == "No GUID") {
                       $('#sidemsg-t').html("Authenticate");
                       $('#flip-t').val('no').slider('refresh');
                       $('#flip-g').val('yes').slider('refresh');
                       $('#greeting').hide();
                       $('#welcome').show();
                       $('#tweets').hide();

                   } else if (idlist == "No Twitter") {
                       $('#sidemsg-t').html("Authenticate");
                       $('#flip-t').val('no').slider('refresh');
                       $('#flip-g').val('yes').slider('refresh');
                       $('#greeting').hide();
                       $('#welcome').show();
                       $('#tweets').hide();

                   } else {
                       //alert(idlist);
                       //$('#flip-t').val('yes').slider('refresh');
                       //$('#tweets').show();
                       $('#tweettype_list').show()
                       getTweets(5);
                   }
               },
               error: function (xhr, error) {
                   console.debug(xhr); console.debug(error);
               },
               complete: function (xhr, status) {
                   // return idlist;
               }

           });
       }

       function getBanner(type, ID, invoke, tw_type) {
           // alert(ID);
           $('#banner_header').html("<a href=\"#\" onclick=\"closeBanner()\" class=\"/ui-nodisc-icon ui-btn ui-shadow ui-corner-all ui-btn-b ui-icon-delete ui-btn-icon-top\"><div id=\"twitterID\"></div></a>").trigger('create');
           var browser_h = parseInt($(document).height())
           if (type == "banner") {
               window.scrollTo(0, 0);
               $('#banner_header').show();
               $("#banner_area").show();
               $('#twitterID').html("Retrieving banner");
               $.ajax({
                   type: "GET",
                   url: "/Mobile/GetBanner",
                   data: "ID=" + ID + "&invoke=" + invoke + "&type=" + tw_type,
                   dataType: "json",
                   success: function (json) {
                       var jsonresp = eval(json);
                       if (jsonresp.doBanner == "true") {
                           var bannertxt = jsonresp.bannerDeets[0].BannerText;
                           var timeout = jsonresp.bannerDeets[0].BannerTime;
                           var screenname = jsonresp.bannerDeets[0].ScreenName;
                           var twitterID = jsonresp.bannerDeets[0].TwitterID;
                           $('#banner_area').html(bannertxt);
                           $('#twitterID').html("Banner from " + twitterID + ":");
                           if (timeout != 0) {
                               clearTimeout(timer1);
                               timer1 = setTimeout(timerStart1, timeout);
                           }
                       }

                   },
                   error: function (response) {
                       //alert(response.responseText);
                       var r = jQuery.parseJSON(response.responseText);
                       //alert("Message: " + r.Message);
                       //alert("StackTrace: " + r.StackTrace);
                       //alert("ExceptionType: " + r.ExceptionType);
                       // console.debug(xhr); console.debug(error);
                   },
                   complete: function (xhr, status) {
                   }

               });
           }

           if (type == 'media') {

               var imghtml = "<img src=\"" + ID + "\"/>"; //g/"/>
               
               $('#banner_header').html("<a href=\"#\" onclick=\"closeBanner()\" class=\"ui-nodisc-icon ui-btn ui-shadow ui-corner-all ui-btn-b ui-icon-delete ui-btn-icon-top\">Close</a>").trigger('create');
               //<div class="ui-icnput-btn ui-btn ui-btn-b">
               //Close
               //<input type="button" data-enhanced="true" value="Enhanced - Theme swatch B">
               //</div>
               $('#banner_header').show();
               $("#banner_area").show();
               $('#banner_area').html(imghtml);
               //clearTimeout(timer1);
               //timer1 = setTimeout(timerStart1, 10000);
           }

       }

       function getBannerC(ID, timeout) {
           //alert(ID);
           var bannertxt = get_cookie(ID);
           $('#banner_area').html(bannertxt);
           clearTimeout(timer1);
           timer1 = setTimeout(timerStart1, timeout);

       }

       function getTweet(ID, type) {
           var midhtml_media = "";
           var midhtml_web = "";
           var midhtml = "";
           $('#full_tweet').html("Retieving tweet ...");
           $.ajax({
               type: "GET",
               url: "/Mobile/GetTweet",
               data: "ID=" + ID + "&type=" + type,
               dataType: "json",
               success: function (json) {
                   var jsonresp = eval(json);
                   var tweet = jsonresp.tweetDeets[0].Tweet;
                   if (jsonresp.tweetDeets[0].MediaUrl.length > 1) {
                       //picture
                       //  icon = "info";
                       var tweetxtra = jsonresp.tweetDeets[0].MediaUrl;
                       var tweettype = "media";
                       midhtml_media = midhtml_media + "<p><a href=\"#\" onclick=\"getBanner('" + tweettype + "','" + tweetxtra + "', 'click','" + type + "')\">" +
             "<img src=\"" + jsonresp.tweetDeets[0].ImageUrl + "\">" +
        "<div class=\"tweets1\">Open image</div></a></p>";
                   }
                   else if (jsonresp.tweetDeets[0].EntityUrl.length > 1) {
                       //web page
                       midhtml_web = midhtml_web + "<p><a href=\"#\" onclick=\"getWebPage('" + jsonresp.tweetDeets[0].EntityUrl + "')\">" +
                        "<div class=\"tweets1\">Open link</div></a><p>";
                   }

                   $('#full_tweet').html(tweet + midhtml_web + midhtml_media);
               },
               error: function (response) {
                   //alert(response.responseText);
                   var r = jQuery.parseJSON(response.responseText);
                   //alert("Message: " + r.Message);
                   //alert("StackTrace: " + r.StackTrace);
                   //alert("ExceptionType: " + r.ExceptionType);
                   // console.debug(xhr); console.debug(error);
               },
               complete: function (xhr, status) {
               }

           });
       }

       function getDays2Go(type) {
           var html_top = "<div class=\"ui-body ui-body-a ui-corner-all\"><table>";
           var html_mid = "";
           var num = 0;
           $.ajax({
               type: "GET",
               url: "/Mobile/getDays2Go",
               //data: "latestID=" + latestID,
               dataType: "json",
               success: function (json) {
                   $.each(json.Days2Go, function (i, result) {
                       if (type == "normal") {
                           html_mid = html_mid + "<tr><td class=\"td80\"><div class=\"days_head\" id=\"days_party\">" + result.days + "</div></td>" +
                                  "<td><div class=\"days_text\">" + result.daystxt + result.text + "</div></td></tr>";
                       } else {
                           html_mid = html_mid + "<tr><td><div id=\"days_party\">" + result.days + "</div></td>" +
                                  "<td><div>" + result.daystxt + result.text + "</div></td><td>" +
                                  "<a href=\"#\" class=\"ui-btn ui-icon-gear ui-btn-c ui-mini ui-btn-icon-left ui-corner-all\" onclick=\"removeDays2Go('" + result.id + "')\">Remove</a></td></tr>";
                       }
                   });
                   num = json.num;

               },
               error: function (xhr, error) {
                   // console.debug(xhr); console.debug(error);
               },
               complete: function (xhr, status) {
                   // return idlist;
                   if (type == "small") {
                       if (num > 0) {
                           $('#days2go').append(html_top + html_mid + "<tr><td><a href=\"#\" class=\"ui-btn ui-icon-gear ui-btn-c ui-mini ui-btn-icon-left ui-corner-all\" onclick=\"getDays2Go('normal')\">Done Editing</a></td></tr></table></div>");
                       }
                   } else {
                       $('#days2go').html(html_top + html_mid + "</table></div>");
                   }
               }

           });


       }

       function removeDays2Go(id) {
          
           $.ajax({
               type: "GET",
               url: "/Mobile/removeDays2Go",
               data: "id=" + id,
               //dataType: "json",
               success: function (json) {
                  
               },
               error: function (xhr, error) {
                   // console.debug(xhr); console.debug(error);
               },
               complete: function (xhr, status) {
                   // return idlist;
                   editDays2Go();
               }

           });


       }


       function setDays2Go(eventname, eventdt, eventid) {
           $.ajax({
               type: "GET",
               url: "/Mobile/setDays2Go",
               data: "eventname=" + eventname + "&eventdatetime=" + eventdt + "&eventid=" + eventid,
               dataType: "json",
               success: function (json) {

               },
               error: function (xhr, error) {
                   // console.debug(xhr); console.debug(error);
               },
               complete: function (xhr, status) {
                   getDays2Go("normal");
               }

           });

       }
    
       function editDays2Go() {       
           var idlistj = get_cookie("IDList");          
           var jsonc = idlistj;
           var jsone = eval('(' + jsonc + ')');
           var jsone2 = eval('(' + jsonc + ')');
        
           var emails = ""
           //alert(idlistj);

           $.each(jsone.Id, function (i, idlist) {

               var email = getID(i, idlistj);
               var name = getFn(i, idlistj);
               emails = emails + "<a href=\"#\" class=\"ui-btn ui-icon-check ui-btn-c ui-mini ui-btn-icon-left ui-corner-all\" style=\"cursor:pointer\" onClick=\"FutureDates('" + email + "',10,1)\">" + email + "</a>";
               //getevents(email, name, i, max, min);
               //getfutureevents(email, name, i, max, min);
               // alert(idlist[0]);
           });
           emails = emails + "<a href=\"#\" class=\"ui-btn ui-icon-minus ui-btn-a ui-mini ui-btn-icon-left ui-corner-all\" style=\"cursor:pointer\" onClick=\"getDays2Go('normal')\">Exit</a>";
           $('#days2go').html("<div class=\"ui-body ui-body-a ui-corner-all\"><b>Select Calendar</b>" + "<div><form>" + emails + "</form></div></div>").trigger('create');

           getDays2Go("small");
           }

  
     function FutureDates(email,max,min) {
             //  alert(email);
         var midhtml = "";
         var datetest = "e";
              var tophtml = "<div class=\"ui-body ui-body-a ui-corner-all\"><table>";
              $.ajax({
                  type: "POST",
                  url: "/Mobile/DoneTest",
                  data: "email=" + email + "&max=" + max + "&min=" + min,
                  dataType: "json",
                  success: function (json) {
                      var jsonresp = eval(json);
                      //type = refresh
                      var typej = jsonresp['type'];
                      if (typej == "refresh") {
                          //alert("refreshing");
                          //window.location.href = '/Mobile/GoogleRefresh';
                          $.ajax({
                              type: "GET",
                              url: "/Mobile/GoogleRefresh",

                              dataType: "json",
                              success: function () {
                                  FutureDates(email, max, min)
                              },
                              error: function () { FutureDates(email, max, min); }
                          });

                      } else {
                          var summary = jsonresp['summary'];

                          // alert("not refreshing");
                          var item_ct = 0;
                          for (_obj in jsonresp.items) item_ct++;
                          //alert(item_ct);
                          if (item_ct != 0) {
                              var datestr = formatDate(min);
                              //$('#sum' + i).append("<br /><div class=\"term1\">" + name + "</div>");
                              $.each(jsonresp.items, function (n, item) {
                                  if (item.status != "cancelled") {
                                      datetest = item.start.dateTime;
                                      var datetest2 = item.start.date;
                                      var start_dt = new Date(item.start.dateTime);
                                      var end_dt = new Date(item.end.dateTime);
                                      var start_d = new Date(item.start.date);
                                      var end_d = new Date(item.end.date);
                                      var stf = parseISO8601Date(item.start.dateTime);
                                      var endf = parseISO8601Date(item.end.dateTime);
                                      var eventname = item.summary.replace("'", "\\'")
                                      //var dts = formatDT(itemstart,"start",itemend);
                                      var dte = "";
                                      var datedb = "";
                                      var res = "";
                                      var newdate = "";
                                      //alert(datetest);
                                      if (datetest != undefined) {//(start_d == "Invalid Date") { = is date and time
                                          //dte = parseISO8601DateFull(item.start.dateTime); //.toString('H:mm tt') + " - " + end_dt;
                                          //datedb = toEpoch(datetest);
                                          //dte = parseISO8601DateFull(item.start.dateTime);
                                          //dte = item.start.dateTime;
                                          //res = dte.toString().split(" ");

                                          //works in kindle:
                                          var daytest = parseISO8601DateFull(item.start.dateTime);
                                          datedb = toEpoch(daytest);
                                          //var res = daytest.toString().split(" ");
                                          //alert(res);
                                          //var fullday = getProperDay(res[0]);
                                          //var justdate = res[2];

                                          //newdate = res[0] + " " + res[1] + " " + res[2];

                                          //datedb = toEpoch(start_dt);
                                          //alert("date time: " + daytest + datedb);
                                      } else {
                                          //dte = item.start.date;
                                          datedb = toEpoch(parseISO8601_short(datetest2)); //works in kindle yes
                                          //alert("just date: " + datetest2 + " .... " + datedb);
                                      }
                                      //formatDT(itemstart, itemend, min); write this back in
                                      // alert(dte + " .... " + datedb);
                                      var location = "";
                                      if (item.location != undefined) {
                                          location = ", " + item.location;
                                      }
                                      //alert(start_dt + item.summary);
                                      midhtml = midhtml + "<a href=\"#\" class=\"ui-btn ui-icon-check ui-btn-c ui-mini ui-btn-icon-left ui-corner-all\" onClick=\"setDays2Go('" + eventname + "','" + datedb + "','" + item.htmlLink + "')\">" + stf + dte + ": " + item.summary + "</a></div>";
                                  }

                              });
                          } else {
                              //     $('#sum' + i).append("<br /><div class=\"term1\">No events for " + name + "</div>");
                          }
                      }
                  },
                  error: function (xhr, error) {
                      //console.debug(xhr); console.debug(error);

                  },
                  complete: function (xhr, status) {
                      //console.debug(xhr); console.debug(error);
                      max = parseInt(max + 10);
                      min = parseInt(min + 10);
                      var getmore = "<a href=\"#\" class=\"ui-btn ui-icon-plus ui-btn-c ui-mini ui-btn-icon-left ui-corner-all\" onClick=\"FutureDates('" + email + "'," + max + "," + min + ")\">Get More</a></div>";
                      var cancel = "<a href=\"#\" class=\"ui-btn ui-icon-minus ui-btn-c ui-mini ui-btn-icon-left ui-corner-all\" onClick=\"getDays2Go('normal')\">Cancel</a></div>";

                      $('#days2go').html(tophtml + midhtml + getmore + cancel + "</div>").trigger('create');

                  }

              });


           //var midhtml = "<div class=\"ui-body ui-body-a ui-corner-all\"><table><tr><td class=\"td80\"><div class=\"d2g\" id=\"days_party\">02</div></td>" + 
          //  "<td><div class=\"dgtxt\">Days until Ursula's party</div></td></tr><tr></table></div>";

              //alert(midhtml);
           
           //$('#days2go').html(midhtml);
   //         <ul data-role="listview">


       }

       function tweetstream() {
           var NewDate = new Date();
           var hournow = NewDate.getUTCHours;

           var tweettypes = get_cookie("tweets");
           $.ajax({
               type: "GET",
               url: "/Mobile/JsonTweetStream",
               data: "timenow=" + hournow + "&getnum=5&tweettypes=" + tweettypes,
               dataType: "json",
               success: function (json) {
                   //dataType: "json",


               },
               error: function (xhr, error) {
                   // console.debug(xhr); console.debug(error);
               },
               complete: function (xhr, status) {
                   // return idlist;
                   editDays2Go();
               }

           });
       }
       function getTweets2(more) {
           $body = $("body");
           $body.addClass("loading");
          
           var NewDate = new Date();
           var hournow = NewDate.getUTCHours;
           var latestID = document.getElementById('toptweet').innerHTML;
           var bannerhtml = "";
           var tophtml = "<ul data-role=\"listview\" class=\"ui-alt-icon\">";
           var loading = "<li><div>Loading .... </div></li>";
           $('#tweetsfull').html(tophtml + loading + "</ul>").trigger('create');
           $('#getmoremy').html("Loading ...");
           $('#getmoref').html("Loading ...");
           $('#getmoremen').html("Loading ...");
           var midhtml_my = "";
           var midhtml_men = "";
           var midhtml_fol = "";
           var midhtml_okf = "";
           var midhtml_dm = "";
           var tweettypes = "dm";
           //get_cookie("tweets");
         
           if (tweettypes == "all") {
               $('#tweetsfull').hide();
               $('#tweets').show();
           } else {
               $('#tweets').hide();
               $('#tweetsfull').show();
           }
           $.ajax({
               type: "GET",
               url: "/Mobile/JsonTweets",
               data: "timenow=" + hournow + "&getnum=" + more + "&tweettypes=" + tweettypes,
               dataType: "json",
               success: function (json) {
                   var jsonresp = eval(json);
                   //type = refresh
                   var tweettype = "none";
                   var timeout = "";
                   var getmore = "";
                   var icon = "false";
                   var bannerType = jsonresp.bannerType;

                   $.each(jsonresp.okfridge, function (n, item) {
                       // alert(item.Tweet);
                       var tweetxtra = "";
                       if (item.BannerText.length > 1) {
                           //alert(item.BannerText);
                           tweettype = "banner";
                           tweetxtra = item.ID;
                           midhtml_okf = midhtml_okf + "<li data-icon=\"bars\"><a href=\"#\" onclick=\"getBanner('" + tweettype + "','" + tweetxtra + "', 'click','okf')\">" +
                           //     "<img src=\"" + item.ImageUrl + "\">" +
        "<div class=\"tweets1\">" + item.Tweet + "</div><p class=\"ui-li-aside\"><strong>" + item.TimeStamp + "</strong></p></a></li>";
                           if ((item.doBanner == 0) && (get_cookie("banner_auto") == "on")) {
                               getBanner('banner', item.ID, 'auto', 'okf');
                           }
                       }
                       else if (item.MediaUrl.length > 1) {
                           //picture
                           tweettype = "media";
                           //  icon = "info";
                           tweetxtra = item.MediaUrl;
                           midhtml_okf = midhtml_okf + "<li><a href=\"#tweet_click\" data-rel=\"popup\" onclick=\"getTweet('" + item.ID + "','okf')\">" +
                           //  "<img src=\"" + item.ImageUrl + "\">" +
        "<div class=\"tweets1\">" + item.Tweet + "</div><p class=\"ui-li-aside\"><strong>" + item.TimeStamp + "</strong></p></a></li>";
                       }
                       else if (item.EntityUrl.length > 1) {
                           //web page
                           midhtml_okf = midhtml_okf + "<li><a href=\"#tweet_click\" data-rel=\"popup\" onclick=\"getTweet('" + item.ID + "','okf')\">" +
                           //  "<img src=\"" + item.ImageUrl + "\">" +
        "<div class=\"tweets1\">" + item.Tweet + "</div><p class=\"ui-li-aside\"><strong>" + item.TimeStamp + "</strong></p></a></li>";
                       } else {

                           midhtml_okf = midhtml_okf + "<li><a href=\"#tweet_click\" data-rel=\"popup\" onclick=\"getTweet('" + item.ID + "','okf')\">" +
                           //  "<img src=\"" + item.ImageUrl + "\">" +
        "<div class=\"tweets1\">" + item.Tweet + "</div><p class=\"ui-li-aside\"><strong>" + item.TimeStamp + "</strong></p></a></li>";
                       }

                   });
                   $.each(jsonresp.mentions, function (n, item) {
                       // alert(item.Tweet);
                       var tweetxtra = "";
                       if (item.BannerText.length > 1) {
                           //alert(item.BannerText);
                           tweettype = "banner";
                           tweetxtra = item.ID;
                           midhtml_men = midhtml_men + "<li data-icon=\"bars\"><a href=\"#\" onclick=\"getBanner('" + tweettype + "','" + tweetxtra + "', 'click','mentions')\">" +
               "<img src=\"" + item.ImageUrl + "\">" +
        "<div class=\"tweets1\">" + item.Tweet + "</div><p class=\"ui-li-aside\"><strong>" + item.TimeStamp + "</strong></p></a></li>";
                           if ((item.doBanner == 0) && (get_cookie("banner_auto") == "on")) {
                               getBanner('banner', item.ID, 'auto', 'mentions');
                           }
                       }
                       else if (item.MediaUrl.length > 1) {
                           //picture
                           tweettype = "media";
                           //  icon = "info";
                           tweetxtra = item.MediaUrl;
                           midhtml_men = midhtml_men + "<li><a href=\"#\" onclick=\"getBanner('" + tweettype + "','" + tweetxtra + "','click','mentions')\">" +
             "<img src=\"" + item.ImageUrl + "\">" +
        "<div class=\"tweets1\">" + item.Tweet + "</div><p class=\"ui-li-aside\"><strong>" + item.TimeStamp + "</strong></p></a></li>";
                       }
                       else if (item.EntityUrl.length > 1) {
                           //web page
                           midhtml_men = midhtml_men + "<li><a href=\"#\" onclick=\"getWebPage('" + item.EntityUrl + "')\">" +
               "<img src=\"" + item.ImageUrl + "\">" +
        "<div class=\"tweets1\">" + item.Tweet + "</div><p class=\"ui-li-aside\"><strong>" + item.TimeStamp + "</strong></p></a></li>";
                       } else {

                           midhtml_men = midhtml_men + "<li><a href=\"#tweet_click\" data-rel=\"popup\" onclick=\"getTweet('" + item.ID + "','mentions')\">" +
               "<img src=\"" + item.ImageUrl + "\">" +
        "<div class=\"tweets1\">" + item.Tweet + "</div><p class=\"ui-li-aside\"><strong>" + item.TimeStamp + "</strong></p></a></li>";
                       }

                   });

                   $.each(jsonresp.home, function (n, item) {
                       // alert(item.Tweet);
                       var tweetxtra = "";
                       if (item.BannerText.length > 1) {
                           //alert(item.BannerText);
                           tweettype = "banner";
                           tweetxtra = item.ID;
                           midhtml_fol = midhtml_fol + "<li data-icon=\"bars\"><a href=\"#\" onclick=\"getBanner('" + tweettype + "','" + tweetxtra + "', 'click','home')\">" +
               "<img src=\"" + item.ImageUrl + "\">" +
        "<div class=\"tweets1\">" + item.Tweet + "</div><p class=\"ui-li-aside\"><strong>" + item.TimeStamp + "</strong></p></a></li>";
                           if ((item.doBanner == 0) && (get_cookie("banner_auto") == "on")) {
                               getBanner('banner', item.ID, 'auto', 'home');
                           }
                       }
                       else if (item.MediaUrl.length > 1) {
                           //picture
                           tweettype = "media";
                           //  icon = "info";
                           tweetxtra = item.MediaUrl;
                           midhtml_fol = midhtml_fol + "<li><a href=\"#\" onclick=\"getBanner('" + tweettype + "','" + tweetxtra + "', 'click','home')\">" +
             "<img src=\"" + item.ImageUrl + "\">" +
        "<div class=\"tweets1\">" + item.Tweet + "</div><p class=\"ui-li-aside\"><strong>" + item.TimeStamp + "</strong></p></a></li>";
                       }
                       else if (item.EntityUrl.length > 1) {
                           //web page
                           midhtml_fol = midhtml_fol + "<li><a href=\"#\" onclick=\"getWebPage('" + item.EntityUrl + "')\">" +
               "<img src=\"" + item.ImageUrl + "\">" +
        "<div class=\"tweets1\">" + item.Tweet + "</div><p class=\"ui-li-aside\"><strong>" + item.TimeStamp + "</strong></p></a></li>";
                       } else {

                           midhtml_fol = midhtml_fol + "<li><a href=\"#tweet_click\" data-rel=\"popup\" onclick=\"getTweet('" + item.ID + "','home')\">" +
               "<img src=\"" + item.ImageUrl + "\">" +
        "<div class=\"tweets1\">" + item.Tweet + "</div><p class=\"ui-li-aside\"><strong>" + item.TimeStamp + "</strong></p></a></li>";
                       }

                   });

                   $.each(jsonresp.mytweets, function (n, item) {
                       // alert(item.Tweet);
                       var tweetxtra = "";
                       if (item.BannerText.length > 1) {
                           //alert(item.BannerText);
                           tweettype = "banner";
                           tweetxtra = item.ID;
                           midhtml_my = midhtml_my + "<li data-icon=\"bars\"><a href=\"#\" onclick=\"getBanner('" + tweettype + "','" + tweetxtra + "', 'click','my')\">" +
        "<div class=\"tweets1\">" + item.Tweet + "</div><p class=\"ui-li-aside\"><strong>" + item.TimeStamp + "</strong></p></a></li>";
                           if ((item.doBanner == 0) && (get_cookie("banner_auto") == "on")) {
                               getBanner('banner', item.ID, 'auto', 'my');
                           }
                       }
                       else if (item.MediaUrl.length > 1) {
                           //picture
                           tweettype = "media";
                           //  icon = "info";
                           tweetxtra = item.MediaUrl;
                           midhtml_my = midhtml_my + "<li data-icon=\"camera\"><a href=\"#\" onclick=\"getBanner('" + tweettype + "','" + tweetxtra + "', 'click','my')\">" +
        "<div class=\"tweets1\">" + item.Tweet + "</div><p class=\"ui-li-aside\"><strong>" + item.TimeStamp + "</strong></p></a></li>";
                       }
                       else if (item.EntityUrl.length > 1) {
                           //web page
                           midhtml_my = midhtml_my + "<li><a href=\"#\" onclick=\"getWebPage('" + item.EntityUrl + "')\">" +
        "<div class=\"tweets1\">" + item.Tweet + "</div><p class=\"ui-li-aside\"><strong>" + item.TimeStamp + "</strong></p></a></li>";
                       } else {

                           midhtml_my = midhtml_my + "<li><a href=\"#tweet_click\" data-rel=\"popup\" onclick=\"getTweet('" + item.ID + "','my')\">" +
        "<div class=\"tweets1\">" + item.Tweet + "</div><p class=\"ui-li-aside\"><strong>" + item.TimeStamp + "</strong></p></a></li>";
                       }

                   });

                   $.each(jsonresp.dm, function (n, item) {
                       // alert(item.Tweet);
                       var tweetxtra = "";

                       midhtml_dm = midhtml_dm + "<li><a href=\"#tweet_click\" data-rel=\"popup\" onclick=\"getTweet('" + item.ID + "','okf')\">" +
                       //  "<img src=\"" + item.ImageUrl + "\">" +
        "<div class=\"tweets1\">" + item.Tweet + "</div><p class=\"ui-li-aside\"><strong>" + item.TimeStamp + "</strong></p></a></li>";


                   });

                   var NewDate = new Date();
                   var hoursnow = NewDate.getHours();
                   var minsnow = NewDate.getMinutes();
                   if (parseInt(hoursnow) < 10) {
                       hoursnow = "0" + hoursnow;
                   }
                   if (parseInt(minsnow) < 10) {
                       minsnow = "0" + minsnow;
                   }
                   var timenow = hoursnow + ":" + minsnow;
                   getmore = parseInt(jsonresp.getmore + 5);
                   var timestamp = timenow;
                   var getmoremy = "<li><a href=\"#\" onclick=\"getTweets('" + getmore + "')\">" +
                   "<div class=\"tweets1\" id=\"getmoremy\">Last updated: " + timestamp + " Get More</div></a></li>";
                   var getmoredm = "<li><a href=\"#\" onclick=\"getTweets('" + getmore + "')\">" +
                   "<div class=\"tweets1\" id=\"getmoredm\">Last updated: " + timestamp + " Get More</div></a></li>";
                   var getmorefol = "<li><a href=\"#\" onclick=\"getTweets('" + getmore + "')\">" +
                   "<div class=\"tweets1\" id=\"getmoref\">Last updated: " + timestamp + " Get More</div></a></li>";
                   var getmoremen = "<li><a href=\"#\" onclick=\"getTweets('" + getmore + "')\">" +
                   "<div class=\"tweets1\" id=\"getmoremen\">Last updated: " + timestamp + " Get More</div></a></li>";
                   var getmoreokf = "<li><a href=\"#\" onclick=\"getTweets('" + getmore + "')\">" +
                   "<div class=\"tweets1\" id=\"getmoreokf\">Last updated: " + timestamp + " Get More</div></a></li>";
                   $('#toptweet').html(jsonresp.latestid);
                   //var ua = navigator.userAgent;
                   //$('#toptweettime').html(timenow + ua);
                   $('#mytweets').html(tophtml + midhtml_my + getmoremy + "</ul>").trigger('create');
                   $('#mentions').html(tophtml + midhtml_men + getmoremen + "</ul>").trigger('create');
                   $('#following').html(tophtml + midhtml_fol + getmorefol + "</ul>").trigger('create');
                   $('#okf').html(tophtml + midhtml_okf + getmoreokf + "</ul>").trigger('create');
                   var ArtID = "555"
                   var newtweet = "<br /><div><label><input type=\"checkbox\" name=\"checkbox-0\">Banner</label></div><div>" +
         "<textarea name=\"textarean_" + ArtID + "\" id=\"commtext_" + ArtID + "\"></textarea><button class=\"ui-btn ui-btn-inline\" onClick=\"SendTweet(" + ArtID + ")\">Add Comment</button></div>";
                   if (tweettypes == "my") {
                       $('#tweetsfull').html(tophtml + midhtml_my + getmoremy + "</ul>" + newtweet).trigger('create');
                   } else if (tweettypes == "men") {
                       $('#tweetsfull').html(tophtml + midhtml_men + getmoremen + "</ul>" + newtweet).trigger('create');
                   } else if (tweettypes == "fol") {
                       $('#tweetsfull').html(tophtml + midhtml_fol + getmorefol + "</ul>" + newtweet).trigger('create');
                   } else if (tweettypes == "okf") {
                       $('#tweetsfull').html(tophtml + midhtml_okf + getmoreokf + "</ul>" + newtweet).trigger('create');
                   } else if (tweettypes == "dm") {
                       $('#tweetsfull').html(tophtml + midhtml_dm + getmoredm + "</ul>" + newtweet).trigger('create');
                   }
                   $('#twct').html("20").trigger('create');
                   //   if (get_cookie("autoupdate") == "on") {
                   clearTimeout(timerA);
                   //timerA = setTimeout(checkNewTweets, 300000);
                    
                   var store = new Lawnchair({
                       adapter: "dom",
                       name: "data_store"
                   }, function (store) {
                   });

                   var me = {
                       key: 'twt_data',
                       html: midhtml_dm
                   };

                   store.save(me);
                   $body.removeClass("loading"); 
               },
               error: function (response) {
                   //alert(response.responseText);
                   //var r = jQuery.parseJSON(response.responseText);

               },
               complete: function (xhr, status) {
               }

           });
       }

       function getTweets3() {
           var midhtml_dm = "mid html";
           var getmoredm = "<li><a href=\"#\" onclick=\"getTweets('10')\">" +
                   "<div class=\"tweets1\" id=\"getmoredm\">Last updated: Get More</div></a></li>";
           var tophtml = "<ul data-role=\"listview\" class=\"ui-alt-icon\">";

           var store = new Lawnchair({
               adapter: "dom",
               name: "data_store"
           }, function (store) {
           });

           store.exists("twt_data", function (available) {
          if (available) {
          store.get("twt_data", function(theHtml) {
              midhtml_dm = theHtml.html;
              $('#tweetsfull').html(tophtml + midhtml_dm + getmoredm + "</ul>").trigger('create');

          });
          } else {
          }
          });
       }

       function getWebPage(url) {
           //$('#cal').toggle();
           //$('#iframe1').toggle();
           document.location.href = url;
       }

       function timetest(ID) {
           //alert("hihi" + ID);
           //clearTimeout(timer1);
       }

       function bannerWait(timetillbanner, ID, screenname) {

           // alert(timetillbanner);
           //timer1 = setTimeout(timerStart1(ID), 5000);
           setTimeout(function () {
               getBanner("banner", ID, "5000", screenname);
           }, timetillbanner)
           //timer1 = setTimeout(timetest(ID),5000);
       }

       function SubmitTwID() {
           var twitterID = document.getElementById("twid").value;
           $.ajax({
               type: "POST",
               url: "/Home/SaveTwID",
               data: "id=" + twitterID,
               dataType: "text/plain",
               success: function (json) {

               },
               error: function (xhr, error) {
                   // console.debug(xhr); console.debug(error);
               },
               complete: function (xhr, status) {
                   //
               }

           });


       }

       function SendTweet(ID) {
           $.ajax({
               type: "GET",
               url: "/Mobile/SendTweet",
               //data: "id=" + twitterID,
               dataType: "text/plain",
               success: function (json) {

               },
               error: function (xhr, error) {
                   // console.debug(xhr); console.debug(error);
               },
               complete: function (xhr, status) {
                   //
               }

           });


       }

       function checkNewTweets() {
           clearTimeout(timerA);
           getTweets(5);
       }


       function formatDateNext(num) {
           var NewDate = new Date();
           NewDate.setDate(NewDate.getDate() + num);
           var day;
           var month;
           var date = NewDate.getUTCDate();
           var daynum = NewDate.getUTCDay();
           //alert(NewDate + " d: " + date + " n: " + daynum);
           if (parseInt(daynum) == 1) {
               day = "Monday";
           } else if (parseInt(daynum) == 2) {
               day = "Tuesday";
           } else if (parseInt(daynum) == 3) {
               day = "Wednesday";
           } else if (parseInt(daynum) == 4) {
               day = "Thursday";
           } else if (parseInt(daynum) == 5) {
               day = "Friday";
           } else if (parseInt(daynum) == 6) {
               day = "Saturday";
           } else if (parseInt(daynum) == 0) {
               day = "Sunday";
           }

           var date_str = day + " " + date;


           return date_str;
       }

       function getProperDay(day) {
           if (day == "Mon") {
               dayout = "Monday";
           } else if (day == "Tue") {
               dayout = "Tuesday";
           } else if (day == "Wed") {
               dayout = "Wednesday";
           } else if (day == "Thu") {
               dayout = "Thursday";
           } else if (day == "Fri") {
               dayout = "Friday";
           } else if (day == "Sat") {
               dayout = "Saturday";
           } else if (day == "Sun") {
               dayout = "Sunday";
           } else {
               dayout = day;
           }

           return dayout;
       }


       function formatDateFull(num) {
           var NewDate = new Date();
           NewDate.setDate(NewDate.getDate() + num);
           var day;
           var month;
           var date = NewDate.getUTCDate();
           var daynum = NewDate.getUTCDay();
           var monthnum = NewDate.getUTCMonth();
           if (parseInt(monthnum) == 1) {
               month = "February";
           } else if (parseInt(monthnum) == 2) {
               month = "March";
           } else if (parseInt(monthnum) == 3) {
               month = "April";
           } else if (parseInt(monthnum) == 4) {
               month = "May";
           } else if (parseInt(monthnum) == 5) {
               month = "June";
           } else if (parseInt(monthnum) == 6) {
               month = "July";
           } else if (parseInt(monthnum) == 7) {
               month = "August";
           } else if (parseInt(monthnum) == 8) {
               month = "September";
           } else if (parseInt(monthnum) == 9) {
               month = "October";
           } else if (parseInt(monthnum) == 10) {
               month = "November";
           } else if (parseInt(monthnum) == 11) {
               month = "December";
           } else if (parseInt(monthnum) == 0) {
               month = "January";
           }
           //alert(NewDate + " d: " + date + " n: " + daynum);
           if (parseInt(daynum) == 1) {
               day = "Monday";
           } else if (parseInt(daynum) == 2) {
               day = "Tuesday";
           } else if (parseInt(daynum) == 3) {
               day = "Wednesday";
           } else if (parseInt(daynum) == 4) {
               day = "Thursday";
           } else if (parseInt(daynum) == 5) {
               day = "Friday";
           } else if (parseInt(daynum) == 6) {
               day = "Saturday";
           } else if (parseInt(daynum) == 0) {
               day = "Sunday";
           }

           var date_str = day + " " + date + " " + month;


           return date_str;
       }

       function processSel(selection) {
           set_cookie("Sel", selection, 360);
          
           var sels = selection.split(",");
           var items = 0;
           while (items < 8) {
               var sel = sels[items];
               var selsp = sel.split("=");
               var flip = selsp[0];
               var val = selsp[1];
               $('#' + flip).val(val).slider('refresh');
               //alert(val + " " + flip);
               sliderChange(val, flip);
               items++;
           }
       }

       function checkKindle_sc() {
           var kindle_sc = "";
           if ($("#checkbox-1a").is(":checked")) {
               // $('#chkBox2').prop('checked', false).checkboxradio('refresh');
               kindle_sc = "on";
           } else {
               kindle_sc = "off";
           }

           return kindle_sc;

       }

       function getSel() {
           //   $('#checkbox-3d').prop('disabled', true).checkboxradio('refresh');
           //   $('#checkbox-3ddiv').addClass("ui-disabled");
           var kindle_sc = get_cookie("kindle_sc");
           var header_text = get_cookie("header");
           //var autoupdate = get_cookie("autoupdate");
           var banner_auto = get_cookie("banner_auto");
           banner_auto = "on"
           var TweetRadio = get_cookie("tweets");
         
           if (TweetRadio == "all") {
               $('#radio-3e').attr('checked', true).checkboxradio('refresh');
               
           }
           if (TweetRadio == "my") {
               $('#radio-3a').attr('checked', true).checkboxradio('refresh'); 
           }
           if (TweetRadio == "fol") {
               $('#radio-3b').attr('checked', true).checkboxradio('refresh'); 
           }
           if (TweetRadio == "men") {
               $('#radio-3c').attr('checked', true).checkboxradio('refresh'); 
           }
           if (TweetRadio == "okf") {
               $('#radio-3d').attr('checked', true).checkboxradio('refresh');
           }

           //alert(header_text);
           $("#header_text").html(header_text).trigger('create');
          // document.getElementById('header_text').value = header_text;
           if (kindle_sc == "on") {
               $('#checkbox-1a').prop('checked', true).checkboxradio('refresh');
           } else {
               $('#checkbox-1a').prop('checked', false).checkboxradio('refresh');
           }
          
           if (banner_auto == "on") {
               $('#checkbox-3').prop('checked', true).checkboxradio('refresh');
           } else {
               $('#checkbox-3').prop('checked', false).checkboxradio('refresh');
              
           }




           $.ajax({
               type: "GET",
               url: "/Mobile/GetSel",
               //data: "sel=" + selected,
               //dataType: "text/plain",
               success: function (sel) {
                   // var arraysel = eval(sel);

                   if (sel == "none") {
                     
                       processSel("flip-t=no,flip-w=no,flip-c=no,flip-g=yes,flip-k=no,flip-s=no,flip-b=no,flip-d=no");
                       //show getstarted and blog
                       $('#welcome').show();

                   } else {
                       processSel(sel);
                   }
               },
               error: function (response) {

               },
               complete: function (xhr, status) {
                   console.debug(xhr); console.debug(status);

               }

           });
       }


       function saveSel() {
           var selected = new Array();
           var str = "twcgksbd";
           var kindle_sc = "";
          
           var banner_auto = "";

           var TweetRadio = $("#tweettypesmenu :radio:checked").val();
           //$('radio3:checked').val();
            var header_text = document.getElementById("header_text").value;
           if ($("#checkbox-1a").is(":checked")) {
               kindle_sc = "on";
           } else {
               kindle_sc = "off";
           }
           if ($("#checkbox-2a").is(":checked")) {
               autoupdate = "on";
           } else {
               autoupdate = "off";
           }
           //if ($("#checkbox-3").is(":checked")) {
              banner_auto = "on";
           //} else {
             //  banner_auto = "off";
           //}
  
           //alert(kindle_sc + header_text);
          // alert(checkKindle_sc());
           set_cookie("kindle_sc", kindle_sc, 360);
           set_cookie("header", header_text, 360);
           //set_cookie("autoupdate", autoupdate, 360);
           set_cookie("banner_auto", banner_auto, 360);
          
           set_cookie("tweets", TweetRadio, 360);
           if (TweetRadio != undefined && document.getElementById('flip-t').value == "yes") {
               getTweets(5);
           }
           for (var i = 0; i < str.length; i++) {
               var nextChar = str.charAt(i);
               var flipstr = "flip-" + nextChar;
               var flipval = document.getElementById(flipstr).value;

               selected.push(flipstr + "=" + flipval);
               //selected.push(("flip" + nextChar).val());
               //   alert(nextChar)
           }

           $.ajax({
               type: "GET",
               url: "/Mobile/SaveSel",
               data: "selection=" + selected,
               dataType: "text/plain",
               success: function (json) {
                   
               },
               error: function (response) {
                   
               },
               complete: function (xhr, status) {
                   
               }

           });
           if (document.getElementById('flip-w').value == "yes") {
               //document.location.href = '/';      
           }
           //$('#checkbox-1a').val('off').checkboxradio("refresh");
       }

     
       function sliderChange(val, id) {
           
           var flipT = document.getElementById('flip-t').value;
           var flipW = document.getElementById('flip-w').value;
           //var flipN = document.getElementById('flip-n').value;
           var flipC = document.getElementById('flip-c').value;
           var flipG = document.getElementById('flip-g').value;
           var flipK = document.getElementById('flip-k').value;
           var flipS = document.getElementById('flip-s').value;
           var flipB = document.getElementById('flip-b').value;
           var flipD = document.getElementById('flip-d').value;
           //clearTimeout(timerA);
           //timerA = setTimeout(checkNewTweets, 600000);

           if (id == "flip-c") {
               if (val == "no") {
                   $('#calblock').hide()
                   $('#calmenulink').html("").trigger('create');
                   //  
               }
               if (val == "yes") {
                   ggl_check("cal");
                   $('#weatherbloc').hide();
                   $('#calmenulink').html("<ul data-role=\"listview\" style=\"margin:0; width:250px;\" data-theme=\"b\" data-inset=\"true\">" +
                   "<li><a href=\"#\" data-rel=\"back\" onclick=\"testa(1, 0)\">Refresh Calendar</a></li></ul>").trigger('create');
                   //$("#mentions").trigger('collapse');
               }
           }

           if (id == "flip-g") {
               if (val == "no") {
                   $('#welcome').hide();
                   $('#sidemsg-t').html("");
                   $('#sidemsg-w').html("");
               }
               if (val == "yes") {
                   $('#welcome').show();
                   $('#greeting').show();
                  
               }
           }

           if (id == "flip-t") {
               if (val == "no") {
                   $('#tweets').hide()
                   $('#tweetsfull').hide()
                   $('#tweettype_list').hide()
                   $('#twtmenulink').html("").trigger('create');
               }
               if (val == "yes") {
                   twt_check();
                   $('#twtmenulink').html("<ul data-role=\"listview\" style=\"margin:0; width:250px;\" data-theme=\"b\" data-inset=\"true\">" +
                   "<li><a href=\"#\" data-rel=\"back\" onclick=\"getTweets(5)\">Refresh Twitter</a></li></ul>").trigger('create');
                 
                   //$('#tweets').show()
                   //$('#tweetsfull').show()
                  

               }
           }

           if (id == "flip-k") {
               if (val == "no") {
                   $('#kindletricks').hide()
               }
               if (val == "yes") {
                   $('#kindletricks').show()

               }
           }

           if (id == "flip-d") {
               if (val == "no") {
                   $('#days2go').hide()
                   $('#sidemsg-d').hide();
               }
               if (val == "yes") {
                   ggl_check("days");
                  
               }
           }

           if (id == "flip-b") {
               if (val == "no") {
                   //$('#blog').hide()
               }
               if (val == "yes") {
                   //$('#blog').show()

               }
           }

           if (id == "flip-s") {
               if (val == "no") {
                   $('#stats').hide();
                   $('#blog').hide();
                   $('#map').hide();
               }
               if (val == "yes") {
                   users_check();
                   $('#stats').show()
                   $('#blog').show()
                   //$('#map').show()

               }
           }

           if (id == "flip-w") {

               if (flipW == "yes" && flipC == "no" && get_cookie("lat") != null) {
                   $('#weatherbloc').show();
                   drawDaysnoCal(0);
               }

               if (flipW == "yes" && flipC == "yes") {
                   $('#weatherbloc').hide();
                   //drawDaysnoCal(0);
               }

               if (val == "no") {
                   $('#weather_next5').hide();
                   $('#weather').hide();
                   $('#weatherbloc').hide();
               }
               if (val == "yes") {

                   GetWeather(0, 1);

               }

           }
           //saveSel();
       }

       function iterateAlphabet() {
           var str = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
           for (var i = 0; i < str.length; i++) {
               var nextChar = str.charAt(i);
               //alert(nextChar)
           }
       }

       function AddComment(ArtID) {
           var name = document.getElementById("commname_" + ArtID).value;
           var comment = document.getElementById("commtext_" + ArtID).value;
           $("#ArtCont_" + ArtID).html("Saving comment ...");
           $.ajax({
               type: "POST",
               url: "/Mobile/SaveComment",
               data: "ArtID=" + ArtID + "&comment=" + comment + "&name=" + name,
               dataType: "json",
               success: function (json) {
                   //ListComments(ArtID);
               },
               error: function (xhr, error) {
                   // console.debug(xhr); console.debug(error);

               },
               complete: function (xhr, status) {
                   //alert(para + ArtID);
                   //$("#ArtCont_" + ArtID).html(ultop + para + comments_html).trigger('create');
                   ListComments(ArtID);
               }
           });

       }

       function ListComments(ArtID) {

           var ultop = "";
           var num = "";
           var comments_html2 = "";
           var comments_html = "<div class=\"ui-body ui-body-a ui-corner-all\"><div style=\"font-size:16px;padding-bottom:5px \">Add your name and a comment:</div><div class=\"ui-grid-a ui-responsive\"><div>Name: " +
         "<input type=\"text\" name=\"Namen_" + ArtID + "\" id=\"commname_" + ArtID + "\" value=\"\"></div>Comment:" +
         "<textarea name=\"textarean_" + ArtID + "\" id=\"commtext_" + ArtID + "\"></textarea><button class=\"ui-btn ui-btn-inline\" onClick=\"AddComment(" + ArtID + ")\">Add Comment</button></div>";
           var para = "<div class=\"ui-body ui-body-a ui-corner-all\"><div style=\"font-size:16px\"><strong>Comments</strong></div><br />";
           $.ajax({
               type: "POST",
               url: "/Mobile/getComments",
               data: "ArtID=" + ArtID,
               dataType: "json",
               success: function (json) {
                   $.each(json.Comments, function (i, result) {
                       para = para + "<div style=\"font-size:10px;padding-bottom:5px\">" + result.datetime + "</div>" +
                "<div style=\"font-size:16px;padding-bottom:5px \">" + result.name + " </div>" +
                "<div style=\"font-size:14px;padding-bottom:5px \">" + result.commenttxt + " </div>" +
                "<div style=\"font-size:10px\"></div><br />";
                       //comments_html2 = comments_html2 + ultop + para + ulbtm;
                   });
                   num = json.num;
               },
               error: function (xhr, error) {
                   // console.debug(xhr); console.debug(error);

               },
               complete: function (xhr, status) {
                   //alert(para + ArtID);
                   $("#CommBubble_" + ArtID).html(num + " comments");
                   $("#ArtCont_" + ArtID).html(ultop + para + "</div><br />" + comments_html + "</div>").trigger('create');


               }
           });

       }


       function ListArticles() {
           var ultop = "<div data-role=\"collapsible-set\" data-theme=\"a\" data-content-theme=\"a\" data-inset=\"false\">";
           var ulbtm = "</div>";
           var ct = 0;
           var para = "";
           //alert("la1");
           $.ajax({
               type: "POST",
               url: "/Mobile/getArticles",
               dataType: "json",
               success: function (json) {
                   $.each(json.Articles, function (i, result) {
                       para = para + "<div data-role=\"collapsible\"><h3 onClick=\"ListComments(" + result.id + ")\">" + result.heading + "<span class=\"ui-li-count\" id=\"CommBubble_" + result.id + "\">" + result.NumComments + " comments</span></h3>" +
                 "<div style=\"font-size:14px\">" + result.arttext + "</div><br /><br />" +
                "<div id=\"ArtCont_" + result.id + "\">Loading comments ...</div></div>";
                       //<div id=\"ArtCont_" + result.id + "\"</div></div>";
                       //comments_html2 = comments_html2 + ultop + para + ulbtm;
                   });
                   // ct = result.NumComments;
               },
               error: function (xhr, error) {
                   // console.debug(xhr); console.debug(error);

               },
               complete: function (xhr, status) {

                   $("#BlogList").html(para).trigger('create');



               }
           });

       }


       function formatDate(num) {
           var NewDate = new Date();
           NewDate.setDate(NewDate.getDate() + num);
           var day;
           var month;
           var date = NewDate.getUTCDate();
           var month = NewDate.getUTCMonth();
           return date;
       }

       function formatDateDayNum(num) {
           var NewDate = new Date();
           NewDate.setDate(NewDate.getDate() + num);
           var day;
           var month;
           var date = NewDate.getUTCDate();
           var daynum = NewDate.getUTCDay();
           //  alert(date);
           return daynum;
       }

       function formatDateDay(num) {
           var NewDate = new Date();
           NewDate.setDate(NewDate.getDate() + num);
           var day;
           var month;
           var date = NewDate.getUTCDate();
           var daynum = NewDate.getUTCDay();
           //alert(NewDate + " d: " + date + " n: " + daynum);
           if (parseInt(daynum) == 1) {
               day = "a";
           } else if (parseInt(daynum) == 2) {
               day = "b";
           } else if (parseInt(daynum) == 3) {
               day = "c";
           } else if (parseInt(daynum) == 4) {
               day = "d";
           } else if (parseInt(daynum) == 5) {
               day = "e";
           } else if (parseInt(daynum) == 6) {
               day = "f";
           } else if (parseInt(daynum) == 0) {
               day = "g";
           }

           if (parseInt(date) < 10) {
               date = "0" + date;
           }

           var date_str = day;

           return date_str;
       }

       function daysBackToMon() {
           var NewDate = new Date();
           i = 7;
           daysback = 0;
           while (i >= 0) {
               i--;
               NewDate.setDate(NewDate.getDate() - i);
               var daynum = NewDate.getUTCDay();
             
               if (parseInt(daynum) == 1) {
                   daysback = i;
               }
               daysback++;
           }

           return daysback;

       }

       function renderTweets(num, type) {
           var tophtml = "<ul data-role=\"listview\" data-split-icon=\"gear\" data-split-theme=\"a\">";
           //var tophtml = "<ul data-role=\"listview\" data-theme=\"a\" data-divider-theme=\"a\" data-count-theme=\"b\">"
           var midhtml = "";
           while (num > 0) {
               midhtml = midhtml + "<li><a href=\"index.html\">" +
                "<img src=\"http://abs.twimg.com/sticky/default_profile_images/default_profile_3_normal.png\">" +
          "<div class=\"tweets1\">Hey Stephen, if you're available at 10am tomorrow, we've got a meeting with the jQuery team.</div>" +
             "<p class=\"ui-li-aside\"><strong>6:24</strong>PM</p>" +
                "</a><a href=\"lists-split-purchase.html\" data-rel=\"dialog\" data-transition=\"slideup\">Purchase album</a></li>";
               //midhtml = midhtml + "<li><table><tr><td>2m</td><td>" +
               //"<div class=\"tweets1\">Hey Stephen, if you're available at 10am tomorrow, we've got a meeting with the jQuery team.</div>" +
               //"</td></tr></table></li>";
               num--;
           }

           $('#' + type).html(tophtml + midhtml + "</ul>").trigger('create');
       }

       function drawNext5(start) {
           var end = 5
           while (end > -1) {
               $('#next' + end).html(formatDateNext(end));
               end--;
           }
       }

       function drawCal() {
           var calhtmltop = "<div class=\"ui-grid-f\">";
           var aplhastr = "abcdefg";
           var calhtmlmid = "";
           //var startDate = daysBackToMon();
           var end = parseInt(0);
           var today = formatDateDay(0);
           var startrow = 1;
           var dayID = 1;
           var daynow = 0;
           // alert(startDate);
           while (end < 5) {
               end++;
               for (var i = 0; i < aplhastr.length; i++) {
                   var nextChar = aplhastr.charAt(i);
                   calhtmlmid = calhtmlmid + "<div class=\"ui-block-" + nextChar + "\"><div class=\"ui-body ui-body-d\" id=\"Cal" + dayID + "\">ID " + dayID + "</div></div>";
                   dayID++;
               }

               $('#caldata').html(calhtmltop + calhtmlmid + "</div>");

           }
           backFillCal(startrow);
       }

       function toEpoch(datestring) {
          // datestring.getTime();
           var newdt = new Date(datestring);
           
           var epoch = parseInt(newdt.getTime() / 1000);
        
           return epoch;
        //var parts = datestring.match(/(\d{2})\/(\d{2})\/(\d{4}) (\d{2}):(\d{2})/);
        //return Date.UTC(+parts[3], parts[2]-1, +parts[1], +parts[4], +parts[5]);
       
       }

       function backFillCal(startrow) {
           var rowfactor = parseInt(startrow * 7);
           var todaynum = formatDateDayNum(0);
           var todayID = parseInt(rowfactor + todaynum);
           var end = (0 - todayID);
           var start = 0;
           while (start < 36) {
               var html = "<div style=\"cursor:pointer\" onclick=\"testa(" + parseInt(end + 1) + "," + end + ")\" class=\"cal_other\">" + formatDate(end) + "</div>";
               var html_today = "<div style=\"cursor:pointer\" onclick=\"testa(" + parseInt(end + 1) + "," + end + ")\" class=\"cal_today\">" + formatDate(end) + "</div>";
               $('#Cal' + start).html(html);
               if (end == 0) {
                   $('#Cal' + start).html(html_today);
               }
               start++;
               end++;
           }
       }

       function formatDateDayID(num) {
           var NewDate = new Date();
           NewDate.setDate(NewDate.getDate() + num);
           var day;
           var month;
           var date = NewDate.getUTCDate();
           var daynum = NewDate.getUTCDay();
           //alert(NewDate + " d: " + date + " n: " + daynum);
           if (parseInt(daynum) == 1) {
               day = "Monday";
           } else if (parseInt(daynum) == 2) {
               day = "Tuesday";
           } else if (parseInt(daynum) == 3) {
               day = "Wednesday";
           } else if (parseInt(daynum) == 4) {
               day = "Thursday";
           } else if (parseInt(daynum) == 5) {
               day = "Friday";
           } else if (parseInt(daynum) == 6) {
               day = "Saturday";
           } else if (parseInt(daynum) == 0) {
               day = "Sunday";
           }

           if (parseInt(date) < 10) {
               date = "0" + date;
           }

           var date_str = day + date;

           return date_str;
       }

       function parseISO8601_short(dateStringInRange) {
        
           var isoExp = /^\s*(\d{4})-(\d\d)-(\d\d)\s*$/,
        date = new Date(NaN), month,
        parts = isoExp.exec(dateStringInRange);

           if (parts) {
               month = +parts[2];
               date.setFullYear(parts[1], month - 1, parts[3]);
               if (month != date.getMonth() + 1) {
                   date.setTime(NaN);
               }
           }
         
           return date;
       }

       function parseISO8601DateFull(s) {

           var re = /(\d{4})-(\d\d)-(\d\d)T(\d\d):(\d\d):(\d\d)(\.\d+)?(Z|([+-])(\d\d):(\d\d))/;

           var d = [];
           try {
               d = s.match(re);
               if (!d) {
                   throw "Couldn't parse ISO 8601 date string '" + s + "'";
               }
               //alert(d);
               // parse strings, leading zeros into proper ints
               var a = [1, 2, 3, 4, 5, 6, 10, 11];
               for (var i in a) {
                   d[a[i]] = parseInt(d[a[i]], 10);
                   //alert(d[a[i]]);
               }
               d[7] = parseFloat(d[7]);
               var hr = parseInt(d[4], 10);
               var min = parseInt(d[5], 10);
               if (hr < 10) {
                   hr = "0" + hr;
               }
               if (min < 10) {
                   min = "0" + min;
               }
               // Date.UTC(year, month[, date[, hrs[, min[, sec[, ms]]]]])
               // note that month is 0-11, not 1-12
               // see https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date/UTC
               var ms = Date.UTC(d[1], d[2] - 1, d[3], d[4], d[5], d[6]);
               //alert(ms + d[2]);
               // if there are milliseconds, add them
               if (d[7] > 0) {
                   ms += Math.round(d[7] * 1000);
               }

               // if there's a timezone, calculate it
               if (d[8] != "Z" && d[10]) {
                   var offset = d[10] * 60 * 60 * 1000;
                   if (d[11]) {
                       offset += d[11] * 60 * 1000;
                   }
                   if (d[9] == "-") {
                       ms -= offset;
                   }
                   else {
                       ms += offset;
                   }
               }
               //alert(ms);

               return new Date(ms);
           } catch (error) {
               return ("All day");
           }
           //return new Date(ms);
       };

       function get_cookie(name) {
           var results = document.cookie.match('(^|;) ?' + name + '=([^;]*)(;|$)');
           if (results)
               return (unescape(results[2]));
           else
               return null;
       }

       function listCookies() {
           var theCookies = document.cookie.split(';');
           var aString = '';
           for (var i = 1; i <= theCookies.length; i++) {
               aString += i + ' ' + theCookies[i - 1] + "<br/>";
           }
           return aString;
       }

       function set_cookie(name, value, days) {
           //value = "data here";
           //alert("set cookie: " + name + " " + value);
           var date = new Date();
           date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
           var expires = "; expires=" + date.toGMTString();
           document.cookie = name + '=' + value + expires + '; path=/'

       }


       function parseISO8601Date(s) {

           // parenthese matches:
           // year month day    hours minutes seconds  
           // dotmilliseconds 
           // tzstring plusminus hours minutes
           var re = /(\d{4})-(\d\d)-(\d\d)T(\d\d):(\d\d):(\d\d)(\.\d+)?(Z|([+-])(\d\d):(\d\d))/;

           var d = [];
           try {
               d = s.match(re);

               // "2010-12-07T11:00:00.000-09:00" parses to:
               //  ["2010-12-07T11:00:00.000-09:00", "2010", "12", "07", "11",
               //     "00", "00", ".000", "-09:00", "-", "09", "00"]
               // "2010-12-07T11:00:00.000Z" parses to:
               //  ["2010-12-07T11:00:00.000Z",      "2010", "12", "07", "11", 
               //     "00", "00", ".000", "Z", undefined, undefined, undefined]

               if (!d) {
                   throw "Couldn't parse ISO 8601 date string '" + s + "'";
               }
               //alert(d);
               // parse strings, leading zeros into proper ints
               var a = [1, 2, 3, 4, 5, 6, 10, 11];
               for (var i in a) {
                   d[a[i]] = parseInt(d[a[i]], 10);
                   //alert(d[a[i]]);
               }
               d[7] = parseFloat(d[7]);
               var hr = parseInt(d[4], 10);
               var min = parseInt(d[5], 10);
               if (hr < 10) {
                   hr = "0" + hr;
               }
               if (min < 10) {
                   min = "0" + min;
               }
               // Date.UTC(year, month[, date[, hrs[, min[, sec[, ms]]]]])
               // note that month is 0-11, not 1-12
               // see https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date/UTC
               var ms = Date.UTC(d[1], d[2] - 1, d[3], d[4], d[5], d[6]);
               //alert(ms + d[2]);
               // if there are milliseconds, add them
               if (d[7] > 0) {
                   ms += Math.round(d[7] * 1000);
               }

               // if there's a timezone, calculate it
               if (d[8] != "Z" && d[10]) {
                   var offset = d[10] * 60 * 60 * 1000;
                   if (d[11]) {
                       offset += d[11] * 60 * 1000;
                   }
                   if (d[9] == "-") {
                       ms -= offset;
                   }
                   else {
                       ms += offset;
                   }
               }
               //alert(ms);
               var outp = hr + ":" + min;
               return outp;
           } catch (error) {
               return ("All day");
           }
           //return new Date(ms);
       };


       function closeMap() {
           $("#map").hide();
       }

       function displayMap() {
           //alert("map");
           //var top = $('#map').position().top;
           //$(window).scrollTop(top);
           var el = document.getElementById("map");
           el.style.visibility = "visible";
           el.style.display = "block";
           el.scrollIntoView(true);
          // $('#map')[0].scrollIntoView(true);
           timerM1 = setInterval(function () { startmap() }, 1000);
           $('#map_spacer').show();
           $('#map').show();
       }


       var timerM1;

       function startmap() {
           clearTimeout(timerM1);
          
           var lat = get_cookie("lat");
           var lng = get_cookie("long");
           if (lat == null) {
               lat = 0;
               lng = 0;
           }

           var map = new GoogleMap(lat, lng);
           map.initialize();
           //google.maps.event.trigger(map, 'resize');

       }

       function GoogleMap(lat, lng) {
           var zoom = 6;
           if (lat == 0) {
               zoom = 2
           }
          // $("#map_overlay").fadeIn();
           $("#map").show();
           this.initialize = function () {

               var map = showMap();
               $('#place_name').html("&nbsp");
               $('#place_name').html("&nbsp");
               $('#place_comments').html("&nbsp");
               $('#comments_ct').html("&nbsp");
               $("#addcomm").hide();
           }
           var showMap = function () {
               ;
               var mapOptions = {
                   zoom: zoom,
                   center: new google.maps.LatLng(parseFloat(lat), parseFloat(lng)),
                   mapTypeId: google.maps.MapTypeId.ROADMAP
               }
               var map = new google.maps.Map(document.getElementById("map_canvas"), mapOptions)
               var bounds;

               google.maps.event.addListener(map, 'bounds_changed', (function () {
                   bounds = map.getBounds();
                   $("#map_msg").html("Map moved ...");
                   var timer;
                   return function () {
                       clearTimeout(timer);
                       timer = setTimeout(function () {

                           bounds = map.getBounds();
                           $("#map_msg").html("Loading ...");
                           setMarkers(map, bounds, "0");
                       }, 2000);
                   }
               } ()));


               infowindow = new google.maps.InfoWindow({
                   content: "holding..."
               });
               $("#map_msg").html("Loading markers ... ");

               return map;
           }

       }

       var timer_m;

       function setMarkers(map, bounds_map, PID) {  //this one
           clearTimeout(timer_m);
           //var bds_fmt = "50,-4,60,4";
           var bds_fmt = format_bounds(bounds_map.toString());
           var marktxt = "";
           removeMarkers();
           var markers_array = [];
           var ct = 0;
           if (parseInt(PID) > 0) {
               //        var infoWindowLive = new google.maps.InfoWindow({ content: 'This one: ' + PID });
           }
           //var timage = '../../Content/images/pin.png';
           var position = getPosition();
           var latlng = position.split(',');
           var tlat = latlng[0];
           var tlng = latlng[1];
           var hereLatLng = new google.maps.LatLng(latlng);

           $.ajax({
               type: "GET",
               url: "/Mobile/GetSitesInRange",
               data: "bounds=" + bds_fmt,
               dataType: "json",
               success: function (json) {
                   var jsonresp = eval(json);
                   //var json_loc = { "points": [{ "lat": tlat, "longval": tlng, "name": "You are here!", "PID": "1"}] };
                   ct = jsonresp.ct; //56.208,-3.15
                   //$.merge(json.points, json_loc.points);
                   //var jsontext = JSON.stringify(json);

                   $.each(jsonresp.points, function (i, markers) {
                       //console.log(jsonresp);
                       //if (markers.PID == parseInt(PID)) {
                       //  var image = 'marker_search.png';
                       //MarkerDetails(markers.UID);
                       //$('#place_name').html(markers.place);
                       //} else if (markers.PID == 1) {
                       //    var image = '../../Content/images/pin.png';
                       // } else {
                       var image = '../../Content/images/pin.png';
                       // }
                       //var infoWindow = new google.maps.InfoWindow({ content: 'Place ID' + markers.PID });
                       var siteLatLng = new google.maps.LatLng(markers.lat, markers.longval);
                       var markerp = new google.maps.Marker({ 'position': siteLatLng });
                       //if (markers.name == "You are here!") {
                       // } else {
                       markers_array.push(markerp);
                       //  }
                       google.maps.event.addListener(markerp, "click", function () {
                           //$('#map_markers').fadeOut().html("<p>Click: " + markers.name + markers.PID + "</p>").fadeIn();
                           if (markers.UID != 1) {
                               MarkerDetails(markers.google, markers.twitter, markers.last);
                               $('#place_name').html(markers.place);
                           } else {
                               //$('#place_name').html(markers.place);
                           }
                           //infoWindow.open(map, markerp);
                       });

                   });


                   var mcOptions = { gridSize: 100, maxZoom: 10 };
                   //$("#map_overlay").fadeOut();
                   var markerCluster = new MarkerClusterer(map, markers_array, mcOptions);
               },
               error: function (xhr, error) {
                   console.debug(xhr); console.debug(error);

               },
               complete: function (xhr, status) {

                   var bannermsg = "";
                   if (ct == 0) {
                       $("#map_msg").html("No users in this view.");

                   } else {
                       $("#map_msg").html(ct + " Loaded. Click pin for more information.");

                   }

               }
           });

       }

       var markers = [];

       function removeMarkers() {
           for (var i = 0; i < markers.length; i++) {
               markers[i].setMap(null);
           }
           markers.length = 0;

       }

       function MarkerDetails(google, twitter, last) {
           var html = "<div>";
           var g_html = "";
           var t_html = "";
           if (twitter == 1) {
               g_html = "<img id=\"logoIMG\" style=\"vertical-align: text-top\" src=\"../../Content/images/Twitter_logo_blue.png\"/>";
           }

           if (google == 1) {
               t_html = "<img id=\"logoIMG\" style=\"vertical-align: text-top\" src=\"../../Content/images/calendar-32.png\"/>";
           }

           html = html + g_html + t_html + " Last access: " + last + "</div>";

           $("#place_comments").html(html).trigger('create');
       }

       function getPosition() {
           var lat = get_cookie("lat");
           var lng = get_cookie("long");

           var loc = lat + "," + lng;

           return loc;

       }


       function format_bounds(bds) {

           if (bds.indexOf("NaN") > -1) {
               var bds6 = "-30,-180,80,180";
           } else {
               var bds2 = bds.replace("((", "");
               var bds3 = bds2.replace("))", "");
               var bds4 = bds3.replace("), (", ",");
               var bds5 = bds4.replace(" ", "");
               var bds6 = bds5.replace(" ", "");
       }
       //alert(bds.indexOf("NaN") + "  " + bds6);
           return (bds6);
       }

     </script>
    
</head>
 
<body>
<div data-role="page">

    <div data-role="header" data-position="fixed">
        <asp:ContentPlaceHolder ID="PageTitleContent" runat="server" />
    </div>
    <div data-role="content">
         <asp:ContentPlaceHolder ID="MainContent" runat="server" />
    </div>
    
   </div>
   
</body>
</html>